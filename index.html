<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Social - Conectando Pessoas e Lugares</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        /* Autenticação */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-screen.hidden {
            display: none;
        }

        .auth-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .auth-header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .auth-header p {
            color: #666;
            margin-bottom: 30px;
        }

        .auth-form {
            text-align: left;
        }

        .auth-form h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
        }

        .auth-form.hidden {
            display: none;
        }

        .social-login {
            margin-top: 25px;
            text-align: center;
        }

        .social-login p {
            color: #666;
            margin-bottom: 15px;
        }

        .social-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .social-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .social-btn.google {
            background: #db4437;
            color: white;
        }

        .social-btn.apple {
            background: #000;
            color: white;
        }

        .social-btn.facebook {
            background: #4267B2;
            color: white;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .themes-section {
            margin: 20px 0;
        }

        .themes-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 10px auto;
            background-size: cover;
            background-position: center;
            border: 3px solid #667eea;
        }

        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: all 0.3s ease;
        }

        .onboarding.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .onboarding-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .onboarding h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .onboarding p {
            margin-bottom: 30px;
            color: #666;
            line-height: 1.6;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .theme-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .theme-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .theme-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        /* Mapa */
        #map {
            height: 100vh;
            width: 100%;
        }

        /* Interface principal */
        .main-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }

        .main-interface > * {
            pointer-events: auto;
        }

        /* Header */
        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        /* Filtros de Mapa */
        .map-filters {
            position: absolute;
            top: 20px;
            left: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            z-index: 1000;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .advanced-filters {
            position: absolute;
            top: 200px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 300px;
        }

        .advanced-filters.hidden {
            display: none;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .checkbox-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-filters label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .checkbox-filters input[type="checkbox"] {
            margin: 0;
        }

        /* Rotas Gravadas */
        .routes-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .route-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .route-date {
            font-size: 12px;
            color: #666;
        }

        .route-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .route-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #666;
        }

        .route-actions {
            display: flex;
            gap: 10px;
        }

        .route-actions .btn-primary,
        .route-actions .btn-secondary {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        /* Marcadores do mapa */
        .user-location-marker {
            background: none;
            border: none;
        }

        .trace-marker {
            background: none;
            border: none;
        }

        .event-marker {
            background: none;
            border: none;
        }

        .business-marker {
            background: none;
            border: none;
        }

        .gpx-marker {
            background: none;
            border: none;
        }

        /* Estilos para navegação entre fotos */
        .popup-navigation {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .nav-btn {
            background: #667eea !important;
            color: white !important;
            border: none !important;
            padding: 8px 12px !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            transition: all 0.3s ease !important;
        }

        .nav-btn:hover:not(:disabled) {
            background: #5a6fd8 !important;
            transform: translateY(-1px) !important;
        }

        .nav-btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }

        .nav-counter {
            font-size: 12px !important;
            color: #666 !important;
            font-weight: bold !important;
            text-align: center !important;
        }

        /* Botão de salvar rota */
        .btn-success {
            background: #28a745 !important;
            color: white !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-weight: bold !important;
            transition: all 0.3s ease !important;
        }

        .btn-success:hover {
            background: #218838 !important;
            transform: translateY(-1px) !important;
        }

        /* Notificação de rota salva */
        .route-saved-notification {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Modal de confirmação para salvar rota */
        .route-confirmation-modal {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .confirmation-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confirmation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .confirmation-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #666;
        }

        .confirmation-body {
            padding: 20px 25px;
        }

        .route-summary {
            margin-bottom: 25px;
        }

        .route-summary h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .summary-label {
            font-weight: 500;
            color: #555;
        }

        .summary-value {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .confirmation-message {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 3px solid #2196f3;
        }

        .confirmation-message p {
            margin: 8px 0;
            color: #1565c0;
            font-size: 14px;
            line-height: 1.4;
        }

        .name-input-section {
            margin-bottom: 20px;
        }

        .name-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .name-input-section input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .name-input-section input:focus {
            outline: none;
            border-color: #667eea;
        }

        .name-input-section small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .confirmation-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 25px;
            border-top: 2px solid #f0f0f0;
        }

        .confirmation-actions .btn-secondary,
        .confirmation-actions .btn-success {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .confirmation-actions .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .confirmation-actions .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .confirmation-actions .btn-success {
            background: #28a745;
            color: white;
        }

        .confirmation-actions .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        /* Botão de teste */
        .btn-info {
            background: #17a2b8 !important;
            color: white !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-weight: bold !important;
            transition: all 0.3s ease !important;
        }

        .btn-info:hover {
            background: #138496 !important;
            transform: translateY(-1px) !important;
        }

        /* Visualizador de fotos */
        .photo-viewer-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
            max-height: 90vh;
            width: 90%;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        .photo-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .photo-viewer-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .photo-viewer-body {
            padding: 20px 25px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .photo-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .photo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 10px;
            background: #f8f9fa;
        }

        .photo-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-details {
            font-size: 12px;
            color: #666;
        }

        /* Foto em tela cheia */
        .fullscreen-photo-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fullscreen-photo-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .photo-caption {
            margin-top: 15px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
        }

        /* Badges e Gamificação */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .badge-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .badge-item.locked {
            background: #6c757d;
            opacity: 0.6;
        }

        .badge-item::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .badge-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .badge-description {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Missões */
        .missions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .mission-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mission-title {
            font-weight: bold;
            color: #333;
        }

        .mission-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .mission-progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .mission-reward {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        /* Marketplace */
        .marketplace-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .marketplace-filters select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            flex: 1;
        }

        .businesses-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .business-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .business-item.mumbuca {
            border-left-color: #28a745;
        }

        .business-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .business-name {
            font-weight: bold;
            color: #333;
        }

        .business-category {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .business-description {
            color: #666;
            margin-bottom: 15px;
        }

        .business-features {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .business-feature {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .mumbuca-badge {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        /* Administração */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        /* Estilos para abas GPX */
        .gpx-tab-content {
            margin-bottom: 20px;
        }

        .gpx-tab-content .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .gpx-tab-content .tab-btn.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .admin-content {
            min-height: 300px;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        /* Botões flutuantes */
        .floating-buttons {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Botões de Gravação */
        .rec-btn {
            background: #e74c3c !important;
            color: white !important;
            animation: pulse 2s infinite;
        }

        .rec-btn:hover {
            background: #c0392b !important;
        }

        .rec-btn.recording {
            background: #e74c3c !important;
            animation: pulse 1s infinite;
        }

        .pause-btn {
            background: #f39c12 !important;
            color: white !important;
        }

        .pause-btn:hover {
            background: #e67e22 !important;
        }

        .stop-btn {
            background: #e74c3c !important;
            color: white !important;
        }

        .stop-btn:hover {
            background: #c0392b !important;
        }

        .recording-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recording-controls.hidden {
            display: none;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        .floating-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Modal de check-in */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .visibility-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .visibility-option {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .visibility-option:hover {
            border-color: #667eea;
        }

        .visibility-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* Painel lateral */
        .side-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 10002;
            overflow-y: auto;
        }

        .side-panel.show {
            right: 0;
        }

        .side-panel-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-panel-content {
            padding: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Lista de rastros */
        .trace-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .trace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .trace-author {
            font-weight: bold;
            color: #667eea;
        }

        .trace-time {
            font-size: 12px;
            color: #666;
        }

        .trace-content {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .trace-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        .action-btn.liked {
            color: #e74c3c;
        }

        /* Missões */
        .mission-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .mission-item::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .mission-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .mission-description {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .mission-reward {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .side-panel {
                width: 100%;
                right: -100%;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats {
                justify-content: center;
            }
            
            .floating-buttons {
                bottom: 20px;
                right: 20px;
            }
        }

        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Autenticação -->
        <div class="auth-screen" id="authScreen">
            <div class="auth-content">
                <div class="auth-header">
                    <h1>🌍 Mapa Social</h1>
                    <p>Conecte-se com pessoas e lugares ao seu redor</p>
                </div>
                
                <!-- Login -->
                <div class="auth-form" id="loginForm">
                    <h2>Entrar</h2>
                    <div class="form-group">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPassword" placeholder="Senha" required>
                    </div>
                    <button class="btn-primary" onclick="login()">Entrar</button>
                    <button class="btn-secondary" onclick="showRegister()">Criar Conta</button>
                    
                    <div class="social-login">
                        <p>Ou entre com:</p>
                        <div class="social-buttons">
                            <button class="social-btn google" onclick="socialLogin('google')">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button class="social-btn apple" onclick="socialLogin('apple')">
                                <i class="fab fa-apple"></i> Apple
                            </button>
                            <button class="social-btn facebook" onclick="socialLogin('facebook')">
                                <i class="fab fa-facebook"></i> Facebook
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Registro -->
                <div class="auth-form hidden" id="registerForm">
                    <h2>Criar Conta</h2>
                    <div class="form-group">
                        <input type="text" id="registerName" placeholder="Nome completo" required>
                    </div>
                    <div class="form-group">
                        <input type="email" id="registerEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" id="registerPhone" placeholder="Telefone (opcional)">
                    </div>
                    <div class="form-group">
                        <input type="password" id="registerPassword" placeholder="Senha" required>
                    </div>
                    <div class="form-group">
                        <textarea id="registerBio" placeholder="Bio curta sobre você..." rows="3"></textarea>
                    </div>
                    
                    <div class="themes-section">
                        <h4>Seus Interesses:</h4>
                        <div class="themes-grid">
                            <div class="theme-option" data-theme="cultura">🎭 Cultura</div>
                            <div class="theme-option" data-theme="esporte">⚽ Esporte</div>
                            <div class="theme-option" data-theme="gastronomia">🍕 Gastronomia</div>
                            <div class="theme-option" data-theme="natureza">🌿 Natureza</div>
                            <div class="theme-option" data-theme="tecnologia">💻 Tecnologia</div>
                            <div class="theme-option" data-theme="arte">🎨 Arte</div>
                            <div class="theme-option" data-theme="negocios">🏢 Negócios</div>
                            <div class="theme-option" data-theme="lifestyle">🌟 Lifestyle</div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="register()">Criar Conta</button>
                    <button class="btn-secondary" onclick="showLogin()">Já tenho conta</button>
                </div>
            </div>
        </div>

        <!-- Onboarding -->
        <div class="onboarding hidden" id="onboarding">
            <div class="onboarding-content">
                <h1>🎯 Configure seu Perfil</h1>
                <p>Personalize sua experiência no Mapa Social</p>
                
                <div class="form-group">
                    <label>Foto de Perfil:</label>
                    <input type="file" id="profilePhoto" accept="image/*" onchange="previewProfilePhoto(event)">
                    <div id="photoPreview" class="photo-preview"></div>
                </div>
                
                <div class="form-group">
                    <label>Nome de Exibição:</label>
                    <input type="text" id="displayName" placeholder="Como você quer ser chamado?">
                </div>
                
                <div class="form-group">
                    <label>Bio:</label>
                    <textarea id="userBio" placeholder="Conte um pouco sobre você..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Preferências de Notificação:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="notifCheckins" checked> Check-ins próximos</label>
                        <label><input type="checkbox" id="notifMissions" checked> Novas missões</label>
                        <label><input type="checkbox" id="notifEvents" checked> Eventos locais</label>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="completeOnboarding()">
                    <i class="fas fa-rocket"></i> Começar Aventura!
                </button>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map"></div>

        <!-- Interface principal -->
        <div class="main-interface">
            <!-- Filtros de Mapa (reposicionados para o topo) -->
            <div class="map-filters">
                <div class="filter-group">
                    <label>📏 Raio:</label>
                    <select id="radiusFilter" onchange="updateMapFilters()">
                        <option value="1000">1km</option>
                        <option value="5000">5km</option>
                        <option value="10000" selected>10km</option>
                        <option value="50000">50km</option>
                        <option value="global">Global</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>⏰ Tempo:</label>
                    <select id="timeFilter" onchange="updateMapFilters()">
                        <option value="now" selected>Agora</option>
                        <option value="future">Futuro</option>
                        <option value="memory">Memória</option>
                        <option value="all">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>🏷️ Categoria:</label>
                    <select id="categoryFilter" onchange="updateMapFilters()">
                        <option value="all" selected>Todas</option>
                        <option value="pessoas">👥 Pessoas</option>
                        <option value="lifestyle">🌟 Lifestyle</option>
                        <option value="cultura">🎭 Cultura</option>
                        <option value="negocios">🏢 Negócios</option>
                        <option value="eventos">🎪 Eventos</option>
                    </select>
                </div>
                
                <button class="filter-btn" onclick="toggleAdvancedFilters()">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>

            <!-- Filtros Avançados -->
            <div class="advanced-filters hidden" id="advancedFilters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Preço:</label>
                        <select id="priceFilter">
                            <option value="all">Todos</option>
                            <option value="free">Gratuito</option>
                            <option value="paid">Pago</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Mumbuca:</label>
                        <select id="mumbucaFilter">
                            <option value="all">Todos</option>
                            <option value="accepted">Aceita</option>
                            <option value="not-accepted">Não aceita</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Ordenar por:</label>
                        <select id="sortFilter">
                            <option value="recent">Mais recentes</option>
                            <option value="popular">Mais populares</option>
                            <option value="nearby">Mais próximos</option>
                            <option value="rating">Melhor avaliados</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Mostrar:</label>
                        <div class="checkbox-filters">
                            <label><input type="checkbox" id="showCheckins" checked> Check-ins</label>
                            <label><input type="checkbox" id="showEvents" checked> Eventos</label>
                            <label><input type="checkbox" id="showBusinesses" checked> Negócios</label>
                            <label><input type="checkbox" id="showMissions" checked> Missões</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botões flutuantes -->
            <div class="floating-buttons">
                <button class="floating-btn primary" onclick="openCheckinModal()" title="Fazer Check-in">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="floating-btn" onclick="toggleSidePanel('traces')" title="Ver Rastros">
                    <i class="fas fa-list"></i>
                </button>
                <button class="floating-btn" onclick="openMissionsModal()" title="Missões">
                    <i class="fas fa-tasks"></i>
                </button>
                <button class="floating-btn" onclick="openBadgesModal()" title="Badges">
                    <i class="fas fa-trophy"></i>
                </button>
                <button class="floating-btn" onclick="openMarketplaceModal()" title="Marketplace">
                    <i class="fas fa-store"></i>
                </button>
                <button class="floating-btn" onclick="centerOnUserLocation()" title="Minha Localização">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="floating-btn" onclick="toggleSidePanel('profile')" title="Perfil">
                    <i class="fas fa-user"></i>
                </button>
                <button class="floating-btn" onclick="toggleSidePanel('routes')" title="Rotas Gravadas">
                    <i class="fas fa-route"></i>
                </button>
                <button class="floating-btn" onclick="openGPXModal()" title="Carregar GPX">
                    <i class="fas fa-file-upload"></i>
                </button>
                <button class="floating-btn admin-only" onclick="openAdminModal()" title="Administração" style="display: none;">
                    <i class="fas fa-cog"></i>
                </button>
                
                <!-- Botão de Gravação -->
                <button class="floating-btn rec-btn" onclick="startRecording()" title="Iniciar Gravação" id="recBtn">
                    <i class="fas fa-circle"></i>
                </button>
                
                <!-- Botões de Controle de Gravação (inicialmente ocultos) -->
                <div class="recording-controls hidden" id="recordingControls">
                    <button class="floating-btn pause-btn" onclick="pauseRecording()" title="Pausar Gravação">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button class="floating-btn stop-btn" onclick="stopRecording()" title="Parar Gravação">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Check-in -->
        <div class="modal" id="checkinModal">
            <div class="modal-content">
                <h2>📍 Fazer Check-in</h2>
                <form id="checkinForm">
                    <div class="form-group">
                        <label>Visibilidade:</label>
                        <div class="visibility-options">
                            <div class="visibility-option" data-visibility="public">
                                <i class="fas fa-globe"></i> Público
                            </div>
                            <div class="visibility-option" data-visibility="friends">
                                <i class="fas fa-users"></i> Amigos
                            </div>
                            <div class="visibility-option" data-visibility="private">
                                <i class="fas fa-lock"></i> Privado
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Mensagem (opcional):</label>
                        <textarea id="checkinMessage" rows="4" placeholder="Conte sobre sua experiência neste lugar... (deixe em branco para apenas marcar o local)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Foto (opcional):</label>
                        <input type="file" id="checkinPhoto" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label>Categoria:</label>
                        <select id="checkinCategory">
                            <option value="cultura">🎭 Cultura</option>
                            <option value="esporte">⚽ Esporte</option>
                            <option value="gastronomia">🍕 Gastronomia</option>
                            <option value="natureza">🌿 Natureza</option>
                            <option value="tecnologia">💻 Tecnologia</option>
                            <option value="arte">🎨 Arte</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn-primary" onclick="closeCheckinModal()">Cancelar</button>
                        <button type="submit" class="btn-primary">Fazer Check-in</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Painel lateral -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <h3 id="sidePanelTitle">Painel</h3>
                <button class="close-btn" onclick="closeSidePanel()">×</button>
            </div>
            <div class="side-panel-content" id="sidePanelContent">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>

        <!-- Modal de Badges -->
        <div class="modal" id="badgesModal">
            <div class="modal-content">
                <h2>🏆 Conquistas e Badges</h2>
                <div class="badges-grid" id="badgesGrid">
                    <!-- Badges serão carregados dinamicamente -->
                </div>
                <button class="btn-primary" onclick="closeBadgesModal()">Fechar</button>
            </div>
        </div>

        <!-- Modal de Missões -->
        <div class="modal" id="missionsModal">
            <div class="modal-content">
                <h2>🎯 Missões Ativas</h2>
                <div class="missions-list" id="missionsList">
                    <!-- Missões serão carregadas dinamicamente -->
                </div>
                <button class="btn-primary" onclick="closeMissionsModal()">Fechar</button>
            </div>
        </div>

        <!-- Modal de Marketplace -->
        <div class="modal" id="marketplaceModal">
            <div class="modal-content">
                <h2>🏪 Marketplace Local</h2>
                <div class="marketplace-filters">
                    <select id="marketplaceCategory" onchange="filterMarketplace()">
                        <option value="all">Todas as categorias</option>
                        <option value="restaurantes">🍽️ Restaurantes</option>
                        <option value="cafes">☕ Cafés</option>
                        <option value="shopping">🛍️ Shopping</option>
                        <option value="servicos">🔧 Serviços</option>
                    </select>
                    <select id="mumbucaFilter" onchange="filterMarketplace()">
                        <option value="all">Todos</option>
                        <option value="mumbuca">💚 Aceita Mumbuca</option>
                        <option value="no-mumbuca">❌ Não aceita</option>
                    </select>
                </div>
                <div class="businesses-list" id="businessesList">
                    <!-- Negócios serão carregados dinamicamente -->
                </div>
                <button class="btn-primary" onclick="closeMarketplaceModal()">Fechar</button>
            </div>
        </div>

        <!-- Modal de Administração -->
        <div class="modal" id="adminModal">
            <div class="modal-content">
                <h2>⚙️ Painel Administrativo</h2>
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="showAdminTab('points')">Pontos</button>
                    <button class="tab-btn" onclick="showAdminTab('events')">Eventos</button>
                    <button class="tab-btn" onclick="showAdminTab('missions')">Missões</button>
                    <button class="tab-btn" onclick="showAdminTab('reports')">Relatórios</button>
                </div>
                <div class="admin-content" id="adminContent">
                    <!-- Conteúdo administrativo será carregado dinamicamente -->
                </div>
                <button class="btn-primary" onclick="closeAdminModal()">Fechar</button>
            </div>
        </div>

        <!-- Modal de Upload GPX -->
        <div class="modal" id="gpxModal">
            <div class="modal-content">
                <h2>🗺️ Criar Rota</h2>
                
                <!-- Abas para diferentes métodos -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                    <button class="tab-btn active" onclick="showGPXTab('gpx')" id="gpxTabBtn">📁 Arquivo GPX</button>
                    <button class="tab-btn" onclick="showGPXTab('photos')" id="photosTabBtn">📸 Apenas Fotos</button>
                </div>
                
                <!-- Aba GPX -->
                <div id="gpxTab" class="gpx-tab-content">
                    <div class="form-group">
                        <label>Arquivo GPX:</label>
                        <input type="file" id="gpxFile" accept=".gpx" onchange="handleGPXUpload(event)">
                    </div>
                </div>
                
                <!-- Aba Fotos -->
                <div id="photosTab" class="gpx-tab-content" style="display: none;">
                    <div class="form-group">
                        <label>Fotos com GPS:</label>
                        <input type="file" id="photosOnly" multiple accept="image/*" onchange="handlePhotosOnlyUpload(event)">
                        <small>Selecione fotos que tenham dados de localização GPS</small>
                    </div>
                    <div class="form-group">
                        <label>Ordenar por:</label>
                        <select id="photoSortOrder" onchange="updatePhotoPreview()">
                            <option value="time">⏰ Data/Hora (cronológica)</option>
                            <option value="name">📝 Nome do arquivo</option>
                            <option value="manual">✋ Manual (arrastar para reordenar)</option>
                        </select>
                    </div>
                </div>
                
                <div id="gpxPreview" style="display: none;">
                    <h4>📊 Resumo da Rota:</h4>
                    <div id="gpxStats"></div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="testGPXFunctionality()" style="margin-right: auto;">
                        🧪 Testar
                    </button>
                    <button type="button" class="btn-info" onclick="testConfirmationModal()" style="margin-right: 10px;">
                        🧪 Testar Modal
                    </button>
                    <button type="button" class="btn-primary" onclick="closeGPXModal()">Cancelar</button>
                    <button type="button" class="btn-primary" id="loadGPXBtn" onclick="loadGPXOnMap()" style="display: none;">
                        🗺️ Carregar no Mapa
                    </button>
                    <button type="button" class="btn-success" id="saveRouteBtn" onclick="savePhotoRoute()" style="display: none;">
                        💾 Salvar Rota
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplicação
        let appState = {
            user: {
                id: null,
                name: 'Usuário',
                email: '',
                phone: '',
                bio: '',
                displayName: '',
                level: 1,
                points: 0,
                selectedThemes: [],
                location: null,
                isAdmin: false,
                notifications: {
                    checkins: true,
                    missions: true,
                    events: true
                }
            },
            traces: [],
            missions: [],
            events: [],
            businesses: [],
            badges: [],
            map: null,
            currentLocation: null,
            filters: {
                radius: 10000,
                time: 'now',
                category: 'all',
                price: 'all',
                mumbuca: 'all',
                sort: 'recent',
                showCheckins: true,
                showEvents: true,
                showBusinesses: true,
                showMissions: true
            },
            // Novas variáveis para GPX
            gpxData: null,
            gpxPhotos: [],
            gpxRouteLayer: null,
            gpxMarkers: []
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Aplicação iniciando...');
            
            // Verificar se EXIF.js está disponível
            if (typeof EXIF !== 'undefined') {
                console.log('✅ EXIF.js carregado com sucesso');
            } else {
                console.error('❌ EXIF.js não está disponível!');
                console.log('🔍 Tentando carregar EXIF.js...');
                
                // Carregar EXIF.js dinamicamente se não estiver disponível
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js';
                script.onload = function() {
                    console.log('✅ EXIF.js carregado dinamicamente');
                };
                script.onerror = function() {
                    console.error('❌ Falha ao carregar EXIF.js');
                };
                document.head.appendChild(script);
            }
            
            checkAuthStatus();
            setupEventListeners();
            checkGeolocation();
            loadInitialData();
            
            // Adicionar navegação por teclado
            setupKeyboardNavigation();
        });

        // Verificar status de autenticação
        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            if (token) {
                // Verificar se o token é válido
                validateToken(token);
            } else {
                showAuthScreen();
            }
        }

        // Mostrar tela de autenticação
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('onboarding').classList.add('hidden');
            document.querySelector('.main-interface').style.display = 'none';
        }

        // Validar token
        function validateToken(token) {
            // Simular validação de token
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (userData.id) {
                appState.user = { ...appState.user, ...userData };
                hideAuthScreen();
                updateUserInterface();
            } else {
                showAuthScreen();
            }
        }

        // Esconder tela de autenticação
        function hideAuthScreen() {
            document.getElementById('authScreen').classList.add('hidden');
            document.querySelector('.main-interface').style.display = 'block';
            // Inicializar mapa quando autenticado
            if (!appState.map) {
                initMap();
            }
        }

        // Carregar dados do usuário
        function loadUserData() {
            const saved = localStorage.getItem('mapaSocialUser');
            if (saved) {
                appState.user = { ...appState.user, ...JSON.parse(saved) };
                updateUserInterface();
            }
        }

        // Salvar dados do usuário
        function saveUserData() {
            localStorage.setItem('mapaSocialUser', JSON.stringify(appState.user));
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Seleção de temas
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
            });

            // Seleção de visibilidade
            document.querySelectorAll('.visibility-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.visibility-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Form de check-in
            document.getElementById('checkinForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitCheckin();
            });

            // Filtros avançados
            document.getElementById('priceFilter').addEventListener('change', applyAdvancedFilters);
            document.getElementById('mumbucaFilter').addEventListener('change', applyAdvancedFilters);
            document.getElementById('sortFilter').addEventListener('change', applyAdvancedFilters);
            document.getElementById('showCheckins').addEventListener('change', applyAdvancedFilters);
            document.getElementById('showEvents').addEventListener('change', applyAdvancedFilters);
            document.getElementById('showBusinesses').addEventListener('change', applyAdvancedFilters);
            document.getElementById('showMissions').addEventListener('change', applyAdvancedFilters);
        }

        // Verificar geolocalização
        function checkGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        appState.currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('Localização obtida:', appState.currentLocation);
                        
                        // Centralizar mapa na localização do usuário se já estiver inicializado
                        if (appState.map) {
                            centerOnUserLocation();
                        }
                    },
                    function(error) {
                        console.error('Erro ao obter localização:', error);
                        alert('Por favor, permita o acesso à sua localização para uma melhor experiência.');
                    }
                );
            }
        }

        // Centralizar mapa na localização do usuário
        function centerOnUserLocation() {
            if (appState.currentLocation && appState.map) {
                appState.map.setView([appState.currentLocation.lat, appState.currentLocation.lng], 15);
                
                // Adicionar marcador da localização do usuário se não existir
                if (!appState.userLocationMarker) {
                    const userIcon = L.divIcon({
                        html: '📍',
                        className: 'user-location-marker',
                        iconSize: [30, 30]
                    });
                    
                    appState.userLocationMarker = L.marker([appState.currentLocation.lat, appState.currentLocation.lng], { 
                        icon: userIcon,
                        zIndexOffset: 1000
                    }).addTo(appState.map);
                } else {
                    appState.userLocationMarker.setLatLng([appState.currentLocation.lat, appState.currentLocation.lng]);
                }
                
                // Mostrar popup informativo
                appState.userLocationMarker.bindPopup('📍 Sua localização atual').openPopup();
                
                // Fechar popup após 3 segundos
                setTimeout(() => {
                    appState.userLocationMarker.closePopup();
                }, 3000);
            } else {
                // Se não tiver localização, solicitar novamente
                checkGeolocation();
            }
        }

        // Funções de autenticação
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            // Simular login
            const userData = {
                id: Date.now(),
                email: email,
                name: 'Usuário Logado',
                displayName: 'Usuário',
                level: 1,
                points: 0,
                selectedThemes: ['cultura', 'gastronomia'],
                isAdmin: false
            };

            // Salvar dados
            localStorage.setItem('authToken', 'token_' + Date.now());
            localStorage.setItem('userData', JSON.stringify(userData));
            
            appState.user = { ...appState.user, ...userData };
            
            // Verificar se é primeiro login
            if (!localStorage.getItem('onboardingCompleted')) {
                showOnboarding();
            } else {
                hideAuthScreen();
                initMap();
            }
        }

        function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const bio = document.getElementById('registerBio').value;
            const selectedThemes = Array.from(document.querySelectorAll('.theme-option.selected'))
                .map(option => option.dataset.theme);

            if (!name || !email || !password) {
                alert('Por favor, preencha os campos obrigatórios.');
                return;
            }

            if (selectedThemes.length === 0) {
                alert('Por favor, selecione pelo menos um tema de interesse.');
                return;
            }

            // Simular registro
            const userData = {
                id: Date.now(),
                name: name,
                email: email,
                phone: phone,
                bio: bio,
                displayName: name,
                level: 1,
                points: 0,
                selectedThemes: selectedThemes,
                isAdmin: false
            };

            // Salvar dados
            localStorage.setItem('authToken', 'token_' + Date.now());
            localStorage.setItem('userData', JSON.stringify(userData));
            
            appState.user = { ...appState.user, ...userData };
            
            // Mostrar onboarding
            showOnboarding();
        }

        function socialLogin(provider) {
            // Simular login social
            alert(`Login com ${provider} em desenvolvimento!`);
        }

        // Mostrar onboarding
        function showOnboarding() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('onboarding').classList.remove('hidden');
        }

        // Completar onboarding
        function completeOnboarding() {
            const displayName = document.getElementById('displayName').value;
            const bio = document.getElementById('userBio').value;
            const notifications = {
                checkins: document.getElementById('notifCheckins').checked,
                missions: document.getElementById('notifMissions').checked,
                events: document.getElementById('notifEvents').checked
            };

            if (!displayName) {
                alert('Por favor, insira um nome de exibição.');
                return;
            }

            // Atualizar usuário
            appState.user.displayName = displayName;
            appState.user.bio = bio;
            appState.user.notifications = notifications;

            // Salvar dados
            localStorage.setItem('userData', JSON.stringify(appState.user));
            localStorage.setItem('onboardingCompleted', 'true');

            // Esconder onboarding
            document.getElementById('onboarding').classList.add('hidden');
            
            // Mostrar interface principal
            document.querySelector('.main-interface').style.display = 'block';
            
            // Inicializar mapa
            initMap();
            
            // Carregar dados iniciais
            loadInitialData();
        }

        // Preview da foto de perfil
        function previewProfilePhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Inicializar mapa
        function initMap() {
            if (appState.map) {
                appState.map.remove();
            }
            
            appState.map = L.map('map').setView([0, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(appState.map);

            // Centralizar no usuário se possível
            if (appState.currentLocation) {
                appState.map.setView([appState.currentLocation.lat, appState.currentLocation.lng], 15);
            }

            // Adicionar marcadores existentes
            addExistingMarkers();
        }

        // Adicionar marcadores existentes
        function addExistingMarkers() {
            // Adicionar rastros
            appState.traces.forEach(trace => {
                addTraceMarker(trace);
            });

            // Adicionar eventos
            appState.events.forEach(event => {
                addEventMarker(event);
            });

            // Adicionar negócios
            appState.businesses.forEach(business => {
                addBusinessMarker(business);
            });
        }

        // Adicionar marcador de evento
        function addEventMarker(event) {
            const icon = L.divIcon({
                html: '🎪',
                className: 'event-marker',
                iconSize: [30, 30]
            });

            const marker = L.marker([event.location.lat, event.location.lng], { icon })
                .addTo(appState.map)
                .bindPopup(createEventPopup(event));

            event.marker = marker;
        }

        // Criar popup de evento
        function createEventPopup(event) {
            return `
                <div style="min-width: 200px;">
                    <h4>${event.title}</h4>
                    <p>${event.description}</p>
                    <small>${formatEventDate(event.startDate)}</small>
                    <div style="margin-top: 10px;">
                        <span style="background: ${event.price === 'free' ? '#28a745' : '#ffc107'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                            ${event.price === 'free' ? 'Gratuito' : 'Pago'}
                        </span>
                        ${event.acceptsMumbuca ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px;">💚 Mumbuca</span>' : ''}
                    </div>
                </div>
            `;
        }

        // Adicionar marcador de negócio
        function addBusinessMarker(business) {
            const icon = L.divIcon({
                html: '🏪',
                className: 'business-marker',
                iconSize: [30, 30]
            });

            const marker = L.marker([business.location.lat, business.location.lng], { icon })
                .addTo(appState.map)
                .bindPopup(createBusinessPopup(business));

            business.marker = marker;
        }

        // Criar popup de negócio
        function createBusinessPopup(business) {
            return `
                <div style="min-width: 200px;">
                    <h4>${business.name}</h4>
                    <p>${business.description}</p>
                    <div style="margin-top: 10px;">
                        <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                            ⭐ ${business.rating}
                        </span>
                        ${business.acceptsMumbuca ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px;">💚 Mumbuca</span>' : ''}
                    </div>
                </div>
            `;
        }

        // Formatar data do evento
        function formatEventDate(date) {
            return new Date(date).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Carregar dados iniciais
        function loadInitialData() {
            loadTraces();
            loadMissions();
            loadEvents();
            loadBusinesses();
            loadBadges();
            updateUserInterface();
            
            // Mostrar botão de admin se for admin
            if (appState.user.isAdmin) {
                document.querySelector('.admin-only').style.display = 'flex';
            }
        }

        // Funções de filtros
        function updateMapFilters() {
            appState.filters.radius = parseInt(document.getElementById('radiusFilter').value);
            appState.filters.time = document.getElementById('timeFilter').value;
            appState.filters.category = document.getElementById('categoryFilter').value;
            
            // Aplicar filtros no mapa
            applyMapFilters();
        }

        // Aplicar filtros avançados
        function applyAdvancedFilters() {
            appState.filters.price = document.getElementById('priceFilter').value;
            appState.filters.mumbuca = document.getElementById('mumbucaFilter').value;
            appState.filters.sort = document.getElementById('sortFilter').value;
            appState.filters.showCheckins = document.getElementById('showCheckins').checked;
            appState.filters.showEvents = document.getElementById('showEvents').checked;
            appState.filters.showBusinesses = document.getElementById('showBusinesses').checked;
            appState.filters.showMissions = document.getElementById('showMissions').checked;
            
            applyMapFilters();
        }

        function toggleAdvancedFilters() {
            const advancedFilters = document.getElementById('advancedFilters');
            advancedFilters.classList.toggle('hidden');
        }

        function applyMapFilters() {
            // Limpar marcadores existentes
            clearMapMarkers();
            
            // Aplicar filtros e recarregar marcadores
            loadFilteredData();
        }

        function clearMapMarkers() {
            // Limpar marcadores do mapa
            if (appState.map) {
                // Limpar todos os marcadores exceto o do usuário
                appState.map.eachLayer((layer) => {
                    if (layer instanceof L.Marker && layer !== appState.userLocationMarker) {
                        appState.map.removeLayer(layer);
                    }
                });
            }
        }

        function loadFilteredData() {
            // Carregar dados filtrados
            console.log('Carregando dados filtrados...', appState.filters);
            
            // Aplicar filtros nos marcadores existentes
            if (appState.map) {
                // Limpar marcadores existentes
                clearMapMarkers();
                
                // Recarregar marcadores com filtros
                addExistingMarkers();
            }
        }

        // Carregar rastros
        function loadTraces() {
            // Simular carregamento de rastros
            appState.traces = [
                {
                    id: 1,
                    author: 'João Silva',
                    message: 'Acabei de visitar este incrível museu de arte moderna! 🎨',
                    location: { lat: -23.5505, lng: -46.6333 },
                    category: 'arte',
                    visibility: 'public',
                    timestamp: new Date(Date.now() - 3600000),
                    likes: 5,
                    comments: 2
                },
                {
                    id: 2,
                    author: 'Maria Santos',
                    message: 'Restaurante fantástico com a melhor pizza da cidade! 🍕',
                    location: { lat: -23.5489, lng: -46.6388 },
                    category: 'gastronomia',
                    visibility: 'public',
                    timestamp: new Date(Date.now() - 7200000),
                    likes: 8,
                    comments: 3
                }
            ];

            // Adicionar marcadores no mapa
            appState.traces.forEach(trace => {
                addTraceMarker(trace);
            });
        }

        // Adicionar marcador de rastro no mapa
        function addTraceMarker(trace) {
            const icon = L.divIcon({
                html: getCategoryIcon(trace.category),
                className: 'trace-marker',
                iconSize: [30, 30]
            });

            const marker = L.marker([trace.location.lat, trace.location.lng], { icon })
                .addTo(appState.map)
                .bindPopup(createTracePopup(trace));

            trace.marker = marker;
        }

        // Obter ícone da categoria
        function getCategoryIcon(category) {
            const icons = {
                cultura: '🎭',
                esporte: '⚽',
                gastronomia: '🍕',
                natureza: '🌿',
                tecnologia: '💻',
                arte: '🎨'
            };
            return icons[category] || '📍';
        }

        // Criar popup do rastro
        function createTracePopup(trace) {
            return `
                <div style="min-width: 200px;">
                    <h4>${trace.author}</h4>
                    <p>${trace.message}</p>
                    <small>${formatTime(trace.timestamp)}</small>
                    <div style="margin-top: 10px;">
                        <button onclick="likeTrace(${trace.id})" class="action-btn ${trace.liked ? 'liked' : ''}">
                            ❤️ ${trace.likes}
                        </button>
                        <button onclick="commentTrace(${trace.id})" class="action-btn">
                            💬 ${trace.comments}
                        </button>
                        <button onclick="viewTraceDetails(${trace.id})" class="action-btn">
                            👁️ Ver
                        </button>
                    </div>
                </div>
            `;
        }

        // Carregar missões
        function loadMissions() {
            appState.missions = [
                {
                    id: 1,
                    title: 'Explorador Cultural',
                    description: 'Visite 3 locais culturais diferentes em uma semana',
                    reward: 100,
                    progress: 0,
                    target: 3,
                    category: 'cultura',
                    type: 'checkin',
                    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 2,
                    title: 'Gastrônomo Aventureiro',
                    description: 'Faça check-in em 5 restaurantes diferentes',
                    reward: 150,
                    progress: 0,
                    target: 5,
                    category: 'gastronomia',
                    type: 'checkin',
                    deadline: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 3,
                    title: 'Social Butterfly',
                    description: 'Interaja com 10 rastros de outros usuários',
                    reward: 200,
                    progress: 0,
                    target: 10,
                    category: 'social',
                    type: 'interaction',
                    deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
                }
            ];
        }

        // Carregar eventos
        function loadEvents() {
            appState.events = [
                {
                    id: 1,
                    title: 'Festival de Cultura',
                    description: 'Evento cultural com música, arte e gastronomia',
                    location: { lat: -23.5505, lng: -46.6333 },
                    category: 'cultura',
                    startDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),
                    endDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
                    price: 'free',
                    acceptsMumbuca: true
                },
                {
                    id: 2,
                    title: 'Workshop de Tecnologia',
                    description: 'Aprenda sobre as últimas tendências em tech',
                    location: { lat: -23.5489, lng: -46.6388 },
                    category: 'tecnologia',
                    startDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000),
                    endDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000),
                    price: 'paid',
                    acceptsMumbuca: false
                }
            ];
        }

        // Carregar negócios
        function loadBusinesses() {
            appState.businesses = [
                {
                    id: 1,
                    name: 'Café Cultural',
                    description: 'Café com ambiente cultural e eventos literários',
                    location: { lat: -23.5505, lng: -46.6333 },
                    category: 'cafes',
                    acceptsMumbuca: true,
                    rating: 4.5,
                    features: ['Wi-Fi', 'Eventos', 'Vegan']
                },
                {
                    id: 2,
                    name: 'Restaurante Tradicional',
                    description: 'Culinária local com ingredientes frescos',
                    location: { lat: -23.5489, lng: -46.6388 },
                    category: 'restaurantes',
                    acceptsMumbuca: false,
                    rating: 4.2,
                    features: ['Delivery', 'Estacionamento']
                }
            ];
        }

        // Carregar badges
        function loadBadges() {
            appState.badges = [
                {
                    id: 1,
                    name: 'Explorer Geek',
                    description: 'Primeiro check-in realizado',
                    icon: '🚀',
                    unlocked: true,
                    unlockedAt: new Date()
                },
                {
                    id: 2,
                    name: 'Rastro Cultural',
                    description: '5 check-ins em locais culturais',
                    icon: '🎭',
                    unlocked: false,
                    progress: 2,
                    target: 5
                },
                {
                    id: 3,
                    name: 'Social Butterfly',
                    description: '50 interações com outros usuários',
                    icon: '🦋',
                    unlocked: false,
                    progress: 15,
                    target: 50
                },
                {
                    id: 4,
                    name: 'Mumbuca Master',
                    description: '10 transações com Mumbuca',
                    icon: '💚',
                    unlocked: false,
                    progress: 0,
                    target: 10
                }
            ];
        }

        // Abrir modal de check-in
        function openCheckinModal() {
            if (!appState.currentLocation) {
                alert('Localização não disponível. Por favor, permita o acesso à sua localização.');
                return;
            }

            document.getElementById('checkinModal').classList.add('show');
            
            // Selecionar visibilidade pública por padrão
            document.querySelector('[data-visibility="public"]').classList.add('selected');
        }

        // Fechar modal de check-in
        function closeCheckinModal() {
            document.getElementById('checkinModal').classList.remove('show');
            document.getElementById('checkinForm').reset();
        }

        // Submeter check-in
        function submitCheckin() {
            const message = document.getElementById('checkinMessage').value.trim();
            const category = document.getElementById('checkinCategory').value;
            const visibility = document.querySelector('.visibility-option.selected')?.dataset.visibility || 'public';
            const photo = document.getElementById('checkinPhoto').files[0];

            if (!appState.currentLocation) {
                alert('Localização não disponível. Por favor, permita o acesso à sua localização.');
                return;
            }

            // Criar novo rastro
            const newTrace = {
                id: Date.now(),
                author: appState.user.displayName || appState.user.name,
                message: message || `Check-in em ${category}`,
                location: appState.currentLocation,
                category: category,
                visibility: visibility,
                timestamp: new Date(),
                likes: 0,
                comments: 0,
                photo: photo ? URL.createObjectURL(photo) : null,
                isSilent: !message // Marca se é um check-in silencioso
            };

            // Adicionar à lista
            appState.traces.unshift(newTrace);
            
            // Adicionar marcador no mapa
            addTraceMarker(newTrace);
            
            // Atualizar interface
            updateUserInterface();
            
            // Fechar modal
            closeCheckinModal();
            
            // Adicionar pontos
            addPoints(10);
            
            // Verificar missões
            checkMissions();
            
            alert('Check-in realizado com sucesso! +10 pontos');
        }

        // Alternar painel lateral
        function toggleSidePanel(type) {
            const panel = document.getElementById('sidePanel');
            const content = document.getElementById('sidePanelContent');
            const title = document.getElementById('sidePanelTitle');

            switch (type) {
                case 'traces':
                    title.textContent = '📍 Rastros Recentes';
                    content.innerHTML = createTracesList();
                    break;
                case 'missions':
                    title.textContent = '🎯 Missões Ativas';
                    content.innerHTML = createMissionsList();
                    break;
                case 'profile':
                    title.textContent = '👤 Meu Perfil';
                    content.innerHTML = createProfileView();
                    break;
                case 'routes':
                    title.textContent = '🗺️ Rotas Gravadas';
                    content.innerHTML = createRoutesView();
                    break;
            }

            panel.classList.add('show');
        }

        // Fechar painel lateral
        function closeSidePanel() {
            document.getElementById('sidePanel').classList.remove('show');
        }

        // Criar lista de rastros
        function createTracesList() {
            if (appState.traces.length === 0) {
                return '<p>Nenhum rastro encontrado.</p>';
            }

            return appState.traces.map(trace => `
                <div class="trace-item">
                    <div class="trace-header">
                        <span class="trace-author">${trace.author}</span>
                        <span class="trace-time">${formatTime(trace.timestamp)}</span>
                    </div>
                    <div class="trace-content">${trace.message}</div>
                    <div class="trace-actions">
                        <button class="action-btn" onclick="likeTrace(${trace.id})">
                            ❤️ ${trace.likes}
                        </button>
                        <button class="action-btn" onclick="commentTrace(${trace.id})">
                            💬 ${trace.comments}
                        </button>
                        <button class="action-btn" onclick="viewTraceDetails(${trace.id})">
                            👁️ Ver
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Criar lista de missões
        function createMissionsList() {
            if (appState.missions.length === 0) {
                return '<p>Nenhuma missão disponível no momento.</p>';
            }

            return appState.missions.map(mission => `
                <div class="mission-item">
                    <div class="mission-title">${mission.title}</div>
                    <div class="mission-description">${mission.description}</div>
                    <div class="mission-reward">
                        <span>💰 ${mission.reward} pontos</span>
                        <span>📊 ${mission.progress}/${mission.target}</span>
                    </div>
                    <button class="btn-primary" onclick="viewMission(${mission.id})" style="margin-top: 10px;">
                        Ver Detalhes
                    </button>
                </div>
            `).join('');
        }

        // Criar visualização do perfil
        function createProfileView() {
            return `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="avatar" style="width: 80px; height: 80px; margin: 0 auto 20px; font-size: 32px;">
                        ${appState.user.name.charAt(0)}
                    </div>
                    <h3>${appState.user.name}</h3>
                    <p>Nível ${appState.user.level}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>📊 Estatísticas</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${appState.traces.length}</div>
                            <div style="font-size: 12px; color: #666;">Rastros Criados</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${appState.user.points}</div>
                            <div style="font-size: 12px; color: #666;">Total de Pontos</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>🎯 Temas de Interesse</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                        ${appState.user.selectedThemes.map(theme => `
                            <span style="padding: 8px 15px; background: #667eea; color: white; border-radius: 20px; font-size: 14px;">
                                ${getCategoryIcon(theme)} ${theme.charAt(0).toUpperCase() + theme.slice(1)}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <button class="btn-primary" onclick="editProfile()" style="width: 100%;">
                    ✏️ Editar Perfil
                </button>
            `;
        }

        // Funções auxiliares
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Agora mesmo';
            if (minutes < 60) return `${minutes}m atrás`;
            if (hours < 24) return `${hours}h atrás`;
            return `${days}d atrás`;
        }

        function addPoints(points) {
            appState.user.points += points;
            
            // Verificar level up
            const newLevel = Math.floor(appState.user.points / 100) + 1;
            if (newLevel > appState.user.level) {
                appState.user.level = newLevel;
                alert(`🎉 Parabéns! Você subiu para o nível ${newLevel}!`);
                
                // Verificar badges de nível
                checkLevelBadges(newLevel);
            }
            
            saveUserData();
            updateUserInterface();
        }

        function checkMissions() {
            // Verificar progresso das missões
            appState.missions.forEach(mission => {
                if (mission.type === 'checkin') {
                    const culturalCheckins = appState.traces.filter(trace => 
                        trace.category === 'cultura' && 
                        trace.author === appState.user.displayName
                    ).length;
                    
                    if (mission.category === 'cultura') {
                        mission.progress = Math.min(culturalCheckins, mission.target);
                    }
                }
            });
            
            // Verificar missões completadas
            checkCompletedMissions();
        }

        function checkLevelBadges(level) {
            // Verificar badges de nível
            if (level === 5) {
                unlockBadge('Level 5 Achiever', '🎯', 'Alcançou o nível 5');
            } else if (level === 10) {
                unlockBadge('Level 10 Master', '👑', 'Alcançou o nível 10');
            }
        }

        function unlockBadge(name, icon, description) {
            const newBadge = {
                id: Date.now(),
                name: name,
                description: description,
                icon: icon,
                unlocked: true,
                unlockedAt: new Date()
            };
            
            appState.badges.push(newBadge);
            alert(`🏆 Novo badge desbloqueado: ${name}!`);
        }

        function checkCompletedMissions() {
            appState.missions.forEach(mission => {
                if (mission.progress >= mission.target && !mission.completed) {
                    mission.completed = true;
                    addPoints(mission.reward);
                    alert(`🎯 Missão completa: ${mission.title}! +${mission.reward} pontos`);
                }
            });
        }

        function updateUserInterface() {
            // Atualizar estatísticas no painel lateral se estiver aberto
            const sidePanelContent = document.getElementById('sidePanelContent');
            if (sidePanelContent && sidePanelContent.innerHTML.includes('createProfileView')) {
                sidePanelContent.innerHTML = createProfileView();
            }
        }

        // Funções de modais
        function openBadgesModal() {
            document.getElementById('badgesModal').classList.add('show');
            loadBadgesContent();
        }

        function closeBadgesModal() {
            document.getElementById('badgesModal').classList.remove('show');
        }

        function openMissionsModal() {
            document.getElementById('missionsModal').classList.add('show');
            loadMissionsContent();
        }

        function closeMissionsModal() {
            document.getElementById('missionsModal').classList.remove('show');
        }

        function openMarketplaceModal() {
            document.getElementById('marketplaceModal').classList.add('show');
            loadMarketplaceContent();
        }

        function closeMarketplaceModal() {
            document.getElementById('marketplaceModal').classList.remove('show');
        }

        function openAdminModal() {
            document.getElementById('adminModal').classList.add('show');
            showAdminTab('points');
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('show');
        }

        // Carregar conteúdo dos modais
        function loadBadgesContent() {
            const badgesGrid = document.getElementById('badgesGrid');
            badgesGrid.innerHTML = appState.badges.map(badge => `
                <div class="badge-item ${badge.unlocked ? '' : 'locked'}">
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    ${!badge.unlocked && badge.progress ? 
                        `<div style="margin-top: 10px; font-size: 12px;">${badge.progress}/${badge.target}</div>` : 
                        ''
                    }
                </div>
            `).join('');
        }

        function loadMissionsContent() {
            const missionsList = document.getElementById('missionsList');
            missionsList.innerHTML = appState.missions.map(mission => `
                <div class="mission-card">
                    <div class="mission-header">
                        <div class="mission-title">${mission.title}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${mission.deadline ? `Vence em ${Math.ceil((mission.deadline - new Date()) / (24 * 60 * 60 * 1000))} dias` : ''}
                        </div>
                    </div>
                    <div style="margin-bottom: 15px; color: #666;">${mission.description}</div>
                    <div class="mission-progress">
                        <div class="mission-progress-bar" style="width: ${(mission.progress / mission.target) * 100}%"></div>
                    </div>
                    <div class="mission-reward">
                        <span>💰 ${mission.reward} pontos</span>
                        <span>📊 ${mission.progress}/${mission.target}</span>
                    </div>
                </div>
            `).join('');
        }

        function loadMarketplaceContent() {
            const businessesList = document.getElementById('businessesList');
            businessesList.innerHTML = appState.businesses.map(business => `
                <div class="business-item ${business.acceptsMumbuca ? 'mumbuca' : ''}">
                    <div class="business-header">
                        <div class="business-name">${business.name}</div>
                        <div class="business-category">${business.category}</div>
                    </div>
                    <div class="business-description">${business.description}</div>
                    <div class="business-features">
                        ${business.features.map(feature => 
                            `<span class="business-feature">${feature}</span>`
                        ).join('')}
                        ${business.acceptsMumbuca ? 
                            '<span class="mumbuca-badge">💚 Aceita Mumbuca</span>' : 
                            ''
                        }
                    </div>
                </div>
            `).join('');
        }

        // Funções administrativas
        function showAdminTab(tab) {
            // Atualizar botões ativos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mostrar conteúdo da aba
            const adminContent = document.getElementById('adminContent');
            
            switch(tab) {
                case 'points':
                    adminContent.innerHTML = createPointsAdminView();
                    break;
                case 'events':
                    adminContent.innerHTML = createEventsAdminView();
                    break;
                case 'missions':
                    adminContent.innerHTML = createMissionsAdminView();
                    break;
                case 'reports':
                    adminContent.innerHTML = createReportsAdminView();
                    break;
            }
        }

        function createPointsAdminView() {
            return `
                <div class="admin-section active">
                    <h3>Gerenciar Pontos de Interesse</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${appState.traces.length}</div>
                            <div class="stat-label">Total de Check-ins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${appState.events.length}</div>
                            <div class="stat-label">Eventos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${appState.businesses.length}</div>
                            <div class="stat-label">Negócios Cadastrados</div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addNewPoint()">+ Adicionar Ponto</button>
                </div>
            `;
        }

        function createEventsAdminView() {
            return `
                <div class="admin-section active">
                    <h3>Gerenciar Eventos</h3>
                    <div class="events-admin-list">
                        ${appState.events.map(event => `
                            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
                                <strong>${event.title}</strong><br>
                                <small>${event.description}</small>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-primary" onclick="addNewEvent()">+ Adicionar Evento</button>
                </div>
            `;
        }

        function createMissionsAdminView() {
            return `
                <div class="admin-section active">
                    <h3>Gerenciar Missões</h3>
                    <div class="missions-admin-list">
                        ${appState.missions.map(mission => `
                            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
                                <strong>${mission.title}</strong><br>
                                <small>${mission.description}</small>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-primary" onclick="addNewMission()">+ Adicionar Missão</button>
                </div>
            `;
        }

        function createReportsAdminView() {
            return `
                <div class="admin-section active">
                    <h3>Relatórios</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${appState.user.points}</div>
                            <div class="stat-label">Total de Pontos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${appState.badges.filter(b => b.unlocked).length}</div>
                            <div class="stat-label">Badges Desbloqueados</div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="exportReport()">📊 Exportar Relatório</button>
                </div>
            `;
        }

        // Criar visualização de rotas gravadas
        function createRoutesView() {
            const savedRoutes = JSON.parse(localStorage.getItem('recordedRoutes') || '[]');
            
            if (savedRoutes.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-route" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>Nenhuma rota gravada</h3>
                        <p>Use o botão REC para gravar suas rotas e aventuras!</p>
                    </div>
                `;
            }

            return `
                <div class="routes-list">
                    ${savedRoutes.map(route => `
                        <div class="route-item">
                            <div class="route-header">
                                <div class="route-name">${route.name}</div>
                                <div class="route-date">${formatRouteDate(route.timestamp)}</div>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat">
                                    <i class="fas fa-clock"></i> ${Math.round(route.duration / 1000 / 60)} min
                                </span>
                                <span class="route-stat">
                                    <i class="fas fa-ruler"></i> ${Math.round(route.distance * 100) / 100} km
                                </span>
                                <span class="route-stat">
                                    <i class="fas fa-map-marker-alt"></i> ${route.coordinates.length} pontos
                                </span>
                                ${route.source === 'photos' ? `
                                    <span class="route-stat">
                                        <i class="fas fa-camera"></i> ${route.photoCount || 0} fotos
                                        ${route.photos ? '💾' : ''}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="route-actions">
                                <button class="btn-primary" onclick="viewRouteOnMap(${route.id})">
                                    <i class="fas fa-eye"></i> Ver no Mapa
                                </button>
                                ${route.source === 'photos' && route.photos ? `
                                    <button class="btn-info" onclick="viewRoutePhotos(${route.id})">
                                        <i class="fas fa-images"></i> Ver Fotos
                                    </button>
                                ` : ''}
                                <button class="btn-secondary" onclick="deleteRoute(${route.id})">
                                    <i class="fas fa-trash"></i> Apagar
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Formatar data da rota
        function formatRouteDate(date) {
            return new Date(date).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Visualizar rota no mapa
        function viewRouteOnMap(routeId) {
            const savedRoutes = JSON.parse(localStorage.getItem('recordedRoutes') || '[]');
            const route = savedRoutes.find(r => r.id === routeId);
            
            if (!route) return;

            // Fechar painel lateral
            closeSidePanel();

            // Limpar rota atual se existir
            if (appState.currentRouteLayer) {
                appState.map.removeLayer(appState.currentRouteLayer);
            }

            // Desenhar rota no mapa
            const routeCoords = route.coordinates.map(coord => [coord.lat, coord.lng]);
            appState.currentRouteLayer = L.polyline(routeCoords, {
                color: '#28a745',
                weight: 4,
                opacity: 0.8
            }).addTo(appState.map);

            // Centralizar mapa na rota
            appState.map.fitBounds(appState.currentRouteLayer.getBounds());

            // Mostrar popup com informações da rota
            const center = route.coordinates[Math.floor(route.coordinates.length / 2)];
            
            let routeInfo = `
                <div style="min-width: 200px;">
                    <h4>${route.name}</h4>
                    <p>📏 Distância: ${Math.round(route.distance * 100) / 100} km</p>
                    <p>⏱️ Duração: ${Math.round(route.duration / 1000 / 60)} min</p>
                    <p>📍 Pontos: ${route.coordinates.length}</p>
            `;
            
            // Adicionar informações específicas para rotas de fotos
            if (route.source === 'photos') {
                routeInfo += `
                    <p>📸 Fotos: ${route.photoCount || 0}</p>
                    ${route.photos ? `
                        <p>🖼️ Imagens salvas: ${route.photos.length} (${Math.round(route.photos.reduce((sum, p) => sum + (p.size || 0), 0) / 1024)}KB)</p>
                    ` : ''}
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <i>Rota criada a partir de fotos com GPS</i>
                    </p>
                `;
            }
            
            routeInfo += `</div>`;
            
            L.popup()
                .setLatLng([center.lat, center.lng])
                .setContent(routeInfo)
                .openOn(appState.map);
        }

        // Apagar rota
        function deleteRoute(routeId) {
            if (!confirm('Tem certeza que deseja apagar esta rota?')) return;

            const savedRoutes = JSON.parse(localStorage.getItem('recordedRoutes') || '[]');
            const updatedRoutes = savedRoutes.filter(r => r.id !== routeId);
            localStorage.setItem('recordedRoutes', JSON.stringify(updatedRoutes));

            // Atualizar visualização
            const content = document.getElementById('sidePanelContent');
            content.innerHTML = createRoutesView();

            alert('Rota apagada com sucesso!');
        }

        // Funções administrativas placeholder
        function addNewPoint() { alert('Funcionalidade em desenvolvimento'); }
        function addNewEvent() { alert('Funcionalidade em desenvolvimento'); }
        function addNewMission() { alert('Funcionalidade em desenvolvimento'); }
        function exportReport() { alert('Funcionalidade em desenvolvimento'); }
        function filterMarketplace() { alert('Funcionalidade em desenvolvimento'); }

        // Funções de Gravação
        let recordingState = {
            isRecording: false,
            isPaused: false,
            startTime: null,
            pauseTime: null,
            totalPausedTime: 0,
            coordinates: [],
            watchId: null
        };

        // ===== FUNÇÕES GPX =====
        
        // Abrir modal GPX
        function openGPXModal() {
            console.log('🔍 Abrindo modal GPX...');
            document.getElementById('gpxModal').classList.add('show');
            // Resetar campos
            document.getElementById('gpxFile').value = '';
            document.getElementById('photosOnly').value = '';
            document.getElementById('gpxPreview').style.display = 'none';
            document.getElementById('loadGPXBtn').style.display = 'none';
            document.getElementById('saveRouteBtn').style.display = 'none';
            
            // Mostrar aba GPX por padrão
            showGPXTab('gpx');
            console.log('✅ Modal GPX aberto com sucesso');
        }

        // Mostrar aba específica do modal GPX
        function showGPXTab(tabName) {
            console.log(`🔄 Mudando para aba: ${tabName}`);
            
            // Atualizar botões ativos
            document.getElementById('gpxTabBtn').classList.remove('active');
            document.getElementById('photosTabBtn').classList.remove('active');
            
            // Esconder todas as abas
            document.getElementById('gpxTab').style.display = 'none';
            document.getElementById('photosTab').style.display = 'none';
            
            // Mostrar aba selecionada
            if (tabName === 'gpx') {
                document.getElementById('gpxTabBtn').classList.add('active');
                document.getElementById('gpxTab').style.display = 'block';
                console.log('✅ Aba GPX ativada');
            } else if (tabName === 'photos') {
                document.getElementById('photosTabBtn').classList.add('active');
                document.getElementById('photosTab').style.display = 'block';
                console.log('✅ Aba Fotos ativada');
            }
            
            // Resetar preview
            document.getElementById('gpxPreview').style.display = 'none';
            document.getElementById('loadGPXBtn').style.display = 'none';
            document.getElementById('saveRouteBtn').style.display = 'none';
            console.log('🔄 Preview resetado');
        }

        // Fechar modal GPX
        function closeGPXModal() {
            document.getElementById('gpxModal').classList.remove('show');
            // Resetar campos
            document.getElementById('gpxFile').value = '';
            document.getElementById('photosOnly').value = '';
            document.getElementById('gpxPreview').style.display = 'none';
            document.getElementById('loadGPXBtn').style.display = 'none';
            document.getElementById('saveRouteBtn').style.display = 'none';
        }

        // Manipular upload do arquivo GPX
        function handleGPXUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('📁 Arquivo GPX selecionado:', file.name);
            
            // Limpar fotos anteriores
            appState.gpxPhotos = [];

            const reader = new FileReader();
            reader.onload = function(e) {
                parseGPXFile(e.target.result);
            };
            reader.readAsText(file);
        }



        // Manipular upload de fotos apenas (sem GPX)
        function handlePhotosOnlyUpload(event) {
            const files = Array.from(event.target.files);
            console.log(`📸 Upload de fotos detectado: ${files.length} arquivos`);
            
            if (files.length === 0) {
                console.log('❌ Nenhum arquivo selecionado');
                return;
            }
            
            // Log detalhado dos arquivos
            files.forEach((file, index) => {
                console.log(`📁 Arquivo ${index + 1}:`, {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    lastModified: new Date(file.lastModified)
                });
            });
            
            console.log('🚀 Iniciando processamento de fotos para criar rota...');
            
            // Processar cada foto para extrair dados GPS
            processPhotosForRoute(files);
        }

        // Parsear arquivo GPX
        function parseGPXFile(gpxContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(gpxContent, 'text/xml');
                
                // Extrair waypoints
                const waypoints = [];
                const wptElements = xmlDoc.getElementsByTagName('wpt');
                
                for (let i = 0; i < wptElements.length; i++) {
                    const wpt = wptElements[i];
                    const lat = parseFloat(wpt.getAttribute('lat'));
                    const lon = parseFloat(wpt.getAttribute('lon'));
                    
                    if (lat && lon) {
                        const name = wpt.getElementsByTagName('name')[0]?.textContent || `Ponto ${i + 1}`;
                        const desc = wpt.getElementsByTagName('desc')[0]?.textContent || '';
                        const cmt = wpt.getElementsByTagName('cmt')[0]?.textContent || '';
                        
                        waypoints.push({
                            lat: lat,
                            lon: lon,
                            name: name,
                            description: desc || cmt,
                            order: i
                        });
                    }
                }

                // Extrair track points se não houver waypoints
                if (waypoints.length === 0) {
                    const trkptElements = xmlDoc.getElementsByTagName('trkpt');
                    for (let i = 0; i < trkptElements.length; i++) {
                        const trkpt = trkptElements[i];
                        const lat = parseFloat(trkpt.getAttribute('lat'));
                        const lon = parseFloat(trkpt.getAttribute('lon'));
                        
                        if (lat && lon) {
                            waypoints.push({
                                lat: lat,
                                lon: lon,
                                name: `Ponto ${i + 1}`,
                                description: '',
                                order: i
                            });
                        }
                    }
                }

                appState.gpxData = {
                    waypoints: waypoints,
                    totalPoints: waypoints.length,
                    bounds: calculateGPXBounds(waypoints)
                };

                showGPXPreview();
                
            } catch (error) {
                console.error('Erro ao parsear GPX:', error);
                alert('Erro ao ler arquivo GPX. Verifique se o arquivo é válido.');
            }
        }

        // Calcular bounds do GPX
        function calculateGPXBounds(waypoints) {
            if (waypoints.length === 0) return null;
            
            let minLat = waypoints[0].lat;
            let maxLat = waypoints[0].lat;
            let minLon = waypoints[0].lon;
            let maxLon = waypoints[0].lon;
            
            waypoints.forEach(wp => {
                minLat = Math.min(minLat, wp.lat);
                maxLat = Math.max(maxLat, wp.lat);
                minLon = Math.min(minLon, wp.lon);
                maxLon = Math.max(maxLon, wp.lon);
            });
            
            return [[minLat, minLon], [maxLat, maxLon]];
        }

        // Processar fotos para criar rota
        async function processPhotosForRoute(files) {
            console.log('🔄 Iniciando processamento de fotos para rota...');
            const waypoints = [];
            const photos = [];
            
            // Mostrar indicador de carregamento
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '📸 Processando fotos e extraindo dados GPS...';
            loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid #667eea; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            document.body.appendChild(loadingDiv);
            console.log('📱 Indicador de carregamento exibido');
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`🔄 Processando foto ${i + 1}/${files.length}: ${file.name}`);
                    
                    // Extrair dados GPS da foto
                    console.log(`🔍 Extraindo GPS de: ${file.name}`);
                    const photoData = await extractGPSFromPhoto(file);
                    console.log(`📊 Dados extraídos:`, photoData);
                    
                    if (photoData && photoData.lat && photoData.lon) {
                        const waypoint = {
                            lat: photoData.lat,
                            lon: photoData.lon,
                            name: file.name,
                            description: photoData.description || '',
                            timestamp: photoData.timestamp,
                            photo: file,
                            order: i
                        };
                        
                        waypoints.push(waypoint);
                        photos.push(file);
                        console.log(`✅ GPS extraído com sucesso: ${photoData.lat}, ${photoData.lon}`);
                        console.log(`📍 Waypoint criado:`, waypoint);
                    } else {
                        console.log(`❌ Foto ${file.name} não possui dados GPS válidos`);
                    }
                }
                
                console.log(`📊 Total de waypoints válidos: ${waypoints.length}`);
                console.log(`📸 Total de fotos processadas: ${photos.length}`);
                
                if (waypoints.length === 0) {
                    console.log('❌ Nenhuma foto com GPS válido encontrada');
                    alert('Nenhuma foto com dados GPS válidos foi encontrada. Verifique se as fotos foram tiradas com GPS ativado.');
                    return;
                }
                
                // Ordenar waypoints por timestamp se disponível
                const sortOrder = document.getElementById('photoSortOrder').value;
                console.log(`🔄 Ordenando waypoints por: ${sortOrder}`);
                
                if (sortOrder === 'time' && waypoints[0].timestamp) {
                    waypoints.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    console.log('⏰ Waypoints ordenados por timestamp');
                } else if (sortOrder === 'name') {
                    waypoints.sort((a, b) => a.name.localeCompare(b.name));
                    console.log('📝 Waypoints ordenados por nome');
                }
                
                // Atualizar ordem após ordenação
                waypoints.forEach((wp, index) => {
                    wp.order = index;
                });
                
                // Criar dados da rota
                appState.gpxData = {
                    waypoints: waypoints,
                    totalPoints: waypoints.length,
                    bounds: calculateGPXBounds(waypoints),
                    source: 'gpx'
                };
                
                appState.gpxPhotos = photos;
                
                console.log('🗺️ Dados da rota criados:', appState.gpxData);
                
                // Mostrar preview
                console.log('🔄 Exibindo preview da rota...');
                showGPXPreview();
                
                console.log(`✅ Rota criada com sucesso a partir de ${waypoints.length} fotos`);
                
            } catch (error) {
                console.error('❌ Erro ao processar fotos:', error);
                alert('Erro ao processar as fotos. Verifique se elas contêm dados GPS válidos.');
            } finally {
                // Remover indicador de carregamento
                if (document.body.contains(loadingDiv)) {
                    document.body.removeChild(loadingDiv);
                    console.log('📱 Indicador de carregamento removido');
                }
            }
        }

        // Extrair dados GPS de uma foto
        async function extractGPSFromPhoto(file) {
            console.log(`🔍 Iniciando extração de GPS de: ${file.name}`);
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    console.log(`📖 Arquivo lido com sucesso: ${file.name}`);
                    const arrayBuffer = e.target.result;
                    console.log(`📊 Tamanho do buffer: ${arrayBuffer.byteLength} bytes`);
                    
                    // Usar EXIF.js para extrair dados GPS
                    try {
                        console.log('🔍 Procurando por dados EXIF...');
                        const exifData = EXIF.readFromBinaryFile(arrayBuffer);
                        console.log('📊 Dados EXIF encontrados:', exifData);
                        
                        if (exifData && exifData.GPSLatitude && exifData.GPSLongitude) {
                            console.log('📍 Dados GPS encontrados:', {
                                GPSLatitude: exifData.GPSLatitude,
                                GPSLatitudeRef: exifData.GPSLatitudeRef,
                                GPSLongitude: exifData.GPSLongitude,
                                GPSLongitudeRef: exifData.GPSLongitudeRef
                            });
                            
                            const lat = convertDMSToDD(exifData.GPSLatitude, exifData.GPSLatitudeRef);
                            const lon = convertDMSToDD(exifData.GPSLongitude, exifData.GPSLongitudeRef);
                            
                            console.log(`🌍 Coordenadas convertidas: Lat ${lat}, Lon ${lon}`);
                            
                            // Extrair timestamp se disponível
                            let timestamp = null;
                            if (exifData.DateTimeOriginal) {
                                timestamp = new Date(exifData.DateTimeOriginal.replace(/(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3'));
                                console.log('⏰ Timestamp original:', exifData.DateTimeOriginal, '->', timestamp);
                            } else if (exifData.DateTime) {
                                timestamp = new Date(exifData.DateTime.replace(/(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3'));
                                console.log('⏰ Timestamp:', exifData.DateTime, '->', timestamp);
                            } else {
                                console.log('⏰ Nenhum timestamp encontrado');
                            }
                            
                            const result = {
                                lat: lat,
                                lon: lon,
                                timestamp: timestamp,
                                description: `Foto: ${file.name}`
                            };
                            
                            console.log('✅ Dados GPS extraídos com sucesso:', result);
                            resolve(result);
                        } else {
                            console.log('❌ Dados GPS não encontrados na foto');
                            if (exifData) {
                                console.log('📊 Dados EXIF disponíveis:', Object.keys(exifData));
                            }
                            resolve(null);
                        }
                    } catch (error) {
                        console.error('❌ Erro ao extrair EXIF:', error);
                        resolve(null);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('❌ Erro ao ler arquivo:', error);
                    resolve(null);
                };
                
                console.log('📖 Iniciando leitura do arquivo...');
                reader.readAsArrayBuffer(file);
            });
        }

        // Converter coordenadas DMS para decimal
        function convertDMSToDD(dms, ref) {
            const degrees = dms[0];
            const minutes = dms[1];
            const seconds = dms[2];
            
            let dd = degrees + minutes / 60 + seconds / 3600;
            
            if (ref === 'S' || ref === 'W') {
                dd = -dd;
            }
            
            return dd;
        }

        // Mostrar preview do GPX
        function showGPXPreview() {
            if (!appState.gpxData) return;
            
            const preview = document.getElementById('gpxPreview');
            const stats = document.getElementById('gpxStats');
            const loadBtn = document.getElementById('loadGPXBtn');
            
            let sourceInfo = '';
            if (appState.gpxData.source === 'photos') {
                sourceInfo = `
                    <div style="margin: 15px 0; padding: 15px; background: #d4edda; border-radius: 10px; border-left: 4px solid #28a745;">
                        <strong>📸 Rota criada a partir de fotos</strong><br>
                        <small>Os pontos foram extraídos dos dados GPS das fotos</small>
                    </div>
                `;
            } else if (appState.gpxData.source === 'gpx') {
                sourceInfo = `
                    <div style="margin: 15px 0; padding: 15px; background: #d1ecf1; border-radius: 10px; border-left: 4px solid #17a2b8;">
                        <strong>📁 Rota carregada do arquivo GPX</strong><br>
                        <small>Os pontos foram extraídos do arquivo GPX enviado</small>
                    </div>
                `;
            }
            
            let statsHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${appState.gpxData.totalPoints}</div>
                        <div style="font-size: 12px; color: #666;">Pontos da Rota</div>
                    </div>
            `;
            
            // Adicionar estatísticas específicas baseadas na fonte
            if (appState.gpxData.source === 'photos') {
                statsHTML += `
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${appState.gpxPhotos.length}</div>
                        <div style="font-size: 12px; color: #666;">Fotos Selecionadas</div>
                    </div>
                `;
            } else if (appState.gpxData.source === 'gpx') {
                statsHTML += `
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">📁</div>
                        <div style="font-size: 12px; color: #666;">Arquivo GPX</div>
                    </div>
                `;
            }
            
            statsHTML += `
                </div>
                ${sourceInfo}
                <div style="margin: 15px 0; padding: 15px; background: #e9ecef; border-radius: 10px;">
                    <strong>Primeiro ponto:</strong> ${appState.gpxData.waypoints[0].name}<br>
                    <strong>Último ponto:</strong> ${appState.gpxData.waypoints[appState.gpxData.waypoints.length - 1].name}
                </div>
            `;
            
            stats.innerHTML = statsHTML;
            
            preview.style.display = 'block';
            loadBtn.style.display = 'block';
            
            // Mostrar botão de salvar apenas para rotas criadas a partir de fotos
            const saveBtn = document.getElementById('saveRouteBtn');
            if (appState.gpxData.source === 'photos') {
                saveBtn.style.display = 'block';
            } else {
                saveBtn.style.display = 'none';
            }
        }

        // Carregar GPX no mapa
        function loadGPXOnMap() {
            if (!appState.gpxData || !appState.map) return;
            
            // Limpar rota anterior se existir
            if (appState.gpxRouteLayer) {
                appState.map.removeLayer(appState.gpxRouteLayer);
            }
            
            // Limpar marcadores anteriores
            appState.gpxMarkers.forEach(marker => {
                appState.map.removeLayer(marker);
            });
            appState.gpxMarkers = [];
            
            // Desenhar rota pelas ruas
            if (appState.gpxData.waypoints.length > 1) {
                console.log('🛣️ Calculando rota pelas ruas...');
                calculateRouteByStreets(appState.gpxData.waypoints);
            }
            
            // Adicionar marcadores com popups
            appState.gpxData.waypoints.forEach((wp, index) => {
                const marker = createGPXMarker(wp, index);
                appState.gpxMarkers.push(marker);
                marker.addTo(appState.map);
            });
            
            // Ajustar visão do mapa
            if (appState.gpxData.bounds) {
                appState.map.fitBounds(appState.gpxData.bounds, { padding: [50, 50] });
            }
            
            // Fechar modal
            closeGPXModal();
            
            // Mostrar mensagem de sucesso
            alert(`Rota GPX carregada com sucesso! ${appState.gpxData.totalPoints} pontos adicionados ao mapa.`);
        }

        // Criar marcador GPX com popup
        function createGPXMarker(waypoint, index) {
            const icon = L.divIcon({
                html: '📍',
                className: 'gpx-marker',
                iconSize: [30, 30]
            });
            
            const marker = L.marker([waypoint.lat, waypoint.lon], { icon });
            
            // Criar popup com informações e foto se disponível
            const popupContent = createGPXPopup(waypoint, index);
            marker.bindPopup(popupContent);
            
            return marker;
        }

        // Criar popup do marcador GPX
        function createGPXPopup(waypoint, index) {
            let photoHTML = '';
            
            // Se houver fotos, tentar associar uma foto ao ponto
            if (appState.gpxPhotos && appState.gpxPhotos.length > 0) {
                const photoIndex = Math.floor((index / appState.gpxData.totalPoints) * appState.gpxPhotos.length);
                const photo = appState.gpxPhotos[photoIndex];
                if (photo) {
                    const photoURL = URL.createObjectURL(photo);
                    photoHTML = `
                        <div style="margin: 10px 0;">
                            <img src="${photoURL}" style="width: 100%; max-width: 200px; border-radius: 8px;">
                        </div>
                    `;
                }
            }
            
            // Adicionar navegação entre fotos se houver mais de uma
            let navigationHTML = '';
            if (appState.gpxData.totalPoints > 1) {
                navigationHTML = `
                    <div class="popup-navigation">
                        <button onclick="navigateToPhoto(${index - 1})" 
                                class="nav-btn" 
                                ${index === 0 ? 'disabled' : ''}>
                            ⬅️ Anterior
                        </button>
                        <span class="nav-counter">
                            ${index + 1} de ${appState.gpxData.totalPoints}
                        </span>
                        <button onclick="navigateToPhoto(${index + 1})" 
                                class="nav-btn" 
                                ${index === appState.gpxData.totalPoints - 1 ? 'disabled' : ''}>
                            Próxima ➡️
                        </button>
                    </div>
                `;
            }
            
            return `
                <div style="min-width: 250px;">
                    <h4>${waypoint.name}</h4>
                    ${waypoint.description ? `<p>${waypoint.description}</p>` : ''}
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        📍 Ponto ${index + 1} de ${appState.gpxData.totalPoints}
                    </div>
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        📍 Coordenadas: ${waypoint.lat.toFixed(6)}, ${waypoint.lon.toFixed(6)}
                    </div>
                    ${photoHTML}
                    ${navigationHTML}
                    <div style="margin-top: 15px;">
                        <button onclick="centerOnWaypoint(${index})" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            🗺️ Centralizar
                        </button>
                    </div>
                </div>
            `;
        }

        // Centralizar mapa em um waypoint específico
        function centerOnWaypoint(index) {
            if (!appState.gpxData || !appState.map) return;
            
            const waypoint = appState.gpxData.waypoints[index];
            if (waypoint) {
                appState.map.setView([waypoint.lat, waypoint.lon], 16);
                
                // Abrir popup do marcador
                const marker = appState.gpxMarkers[index];
                if (marker) {
                    marker.openPopup();
                }
            }
        }

        // Navegar para uma foto específica
        function navigateToPhoto(index) {
            console.log(`🧭 Navegando para foto ${index + 1}`);
            
            if (!appState.gpxData || !appState.map) {
                console.log('❌ Dados GPX ou mapa não disponíveis');
                return;
            }
            
            // Validar índice
            if (index < 0 || index >= appState.gpxData.totalPoints) {
                console.log(`❌ Índice inválido: ${index}`);
                return;
            }
            
            const waypoint = appState.gpxData.waypoints[index];
            if (waypoint) {
                // Centralizar mapa no waypoint
                appState.map.setView([waypoint.lat, waypoint.lon], 16);
                
                // Abrir popup do marcador
                const marker = appState.gpxMarkers[index];
                if (marker) {
                    marker.openPopup();
                    console.log(`✅ Popup aberto para foto ${index + 1}`);
                } else {
                    console.log(`❌ Marcador não encontrado para índice ${index}`);
                }
            } else {
                console.log(`❌ Waypoint não encontrado para índice ${index}`);
            }
        }

        // Calcular rota pelas ruas usando OSRM
        async function calculateRouteByStreets(waypoints) {
            console.log('🛣️ Iniciando cálculo de rota pelas ruas...');
            
            if (!waypoints || waypoints.length < 2) {
                console.log('❌ Poucos waypoints para calcular rota');
                return;
            }
            
            // Mostrar indicador de carregamento
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '🛣️ Calculando rota pelas ruas...';
            loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid #667eea; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            document.body.appendChild(loadingDiv);
            
            try {
                // Construir string de coordenadas para OSRM
                const coordinates = waypoints.map(wp => `${wp.lon},${wp.lat}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;
                
                console.log('🌐 Fazendo requisição para OSRM:', url);
                
                // Timeout de 15 segundos
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), 15000)
                );
                
                const response = await Promise.race([
                    fetch(url),
                    timeoutPromise
                ]);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Resposta OSRM:', data);
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]); // OSRM retorna [lon, lat]
                    
                    // Remover rota anterior se existir
                    if (appState.gpxRouteLayer) {
                        appState.map.removeLayer(appState.gpxRouteLayer);
                    }
                    
                    // Desenhar nova rota pelas ruas
                    appState.gpxRouteLayer = L.geoJSON(route.geometry, {
                        style: {
                            color: '#28a745',
                            weight: 4,
                            opacity: 0.8
                        }
                    }).addTo(appState.map);
                    
                    console.log('✅ Rota pelas ruas desenhada com sucesso');
                    
                    // Mostrar informações da rota
                    const distance = (route.distance / 1000).toFixed(2);
                    const duration = Math.round(route.duration / 60);
                    
                    // Atualizar loading com informações da rota
                    loadingDiv.innerHTML = `
                        ✅ Rota calculada!<br>
                        📏 Distância: ${distance} km<br>
                        ⏱️ Tempo estimado: ${duration} min
                    `;
                    
                    // Remover loading após 3 segundos
                    setTimeout(() => {
                        if (document.body.contains(loadingDiv)) {
                            document.body.removeChild(loadingDiv);
                        }
                    }, 3000);
                    
                } else {
                    throw new Error('Nenhuma rota encontrada na resposta');
                }
                
            } catch (error) {
                console.error('❌ Erro ao calcular rota pelas ruas:', error);
                
                // Fallback: desenhar linha reta
                console.log('🔄 Usando fallback: linha reta entre pontos');
                drawStraightLineRoute(waypoints);
                
                // Atualizar loading com erro
                loadingDiv.innerHTML = `
                    ❌ Erro ao calcular rota pelas ruas<br>
                    🔄 Usando linha reta como fallback
                `;
                
                // Remover loading após 3 segundos
                setTimeout(() => {
                    if (document.body.contains(loadingDiv)) {
                        document.body.removeChild(loadingDiv);
                    }
                }, 3000);
            }
        }

        // Fallback: desenhar linha reta entre pontos
        function drawStraightLineRoute(waypoints) {
            console.log('📏 Desenhando linha reta entre pontos...');
            
            // Remover rota anterior se existir
            if (appState.gpxRouteLayer) {
                appState.map.removeLayer(appState.gpxRouteLayer);
            }
            
            // Desenhar linha reta
            const coordinates = waypoints.map(wp => [wp.lat, wp.lon]);
            appState.gpxRouteLayer = L.polyline(coordinates, {
                color: '#ff6b6b',
                weight: 3,
                opacity: 0.6,
                dashArray: '5, 5'
            }).addTo(appState.map);
            
            console.log('✅ Linha reta desenhada como fallback');
        }

        // Configurar navegação por teclado
        function setupKeyboardNavigation() {
            console.log('⌨️ Configurando navegação por teclado...');
            
            document.addEventListener('keydown', function(event) {
                // Só navegar se houver dados GPX e popup aberto
                if (!appState.gpxData || !appState.gpxMarkers) return;
                
                // Verificar se algum popup está aberto
                const openPopup = document.querySelector('.leaflet-popup');
                if (!openPopup) return;
                
                // Encontrar o índice do waypoint atual baseado no popup aberto
                let currentIndex = -1;
                for (let i = 0; i < appState.gpxMarkers.length; i++) {
                    if (appState.gpxMarkers[i].isPopupOpen()) {
                        currentIndex = i;
                        break;
                    }
                }
                
                if (currentIndex === -1) return;
                
                console.log(`⌨️ Tecla pressionada: ${event.key}, waypoint atual: ${currentIndex + 1}`);
                
                switch (event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        if (currentIndex > 0) {
                            navigateToPhoto(currentIndex - 1);
                        }
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        if (currentIndex < appState.gpxData.totalPoints - 1) {
                            navigateToPhoto(currentIndex + 1);
                        }
                        break;
                    case 'Escape':
                        event.preventDefault();
                        // Fechar popup atual
                        const marker = appState.gpxMarkers[currentIndex];
                        if (marker) {
                            marker.closePopup();
                        }
                        break;
                }
            });
            
            console.log('✅ Navegação por teclado configurada');
        }

        // Salvar rota criada a partir de fotos
        function savePhotoRoute() {
            console.log('💾 Iniciando processo de salvamento da rota...');
            
            if (!appState.gpxData || appState.gpxData.source !== 'photos') {
                console.log('❌ Dados GPX não disponíveis ou não são de fotos');
                console.log('📊 Estado atual:', appState.gpxData);
                return;
            }
            
            console.log('📊 Waypoints disponíveis:', appState.gpxData.waypoints);
            console.log('📸 Fotos disponíveis:', appState.gpxPhotos);
            
            // Calcular distância total da rota
            let totalDistance = 0;
            try {
                for (let i = 1; i < appState.gpxData.waypoints.length; i++) {
                    const prev = appState.gpxData.waypoints[i - 1];
                    const curr = appState.gpxData.waypoints[i];
                    console.log(`📍 Calculando distância entre pontos ${i-1} e ${i}:`, prev, curr);
                    
                    if (prev.lat && prev.lon && curr.lat && curr.lon) {
                        const distance = getDistanceFromLatLonInKm(prev.lat, prev.lon, curr.lat, curr.lon);
                        totalDistance += distance;
                        console.log(`📏 Distância calculada: ${distance} km`);
                    } else {
                        console.log('❌ Coordenadas inválidas:', { prev, curr });
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao calcular distância:', error);
                alert('Erro ao calcular a distância da rota. Verifique se as fotos têm dados GPS válidos.');
                return;
            }
            
            console.log(`📏 Distância total calculada: ${totalDistance} km`);
            
            // Calcular duração estimada (baseada na distância e velocidade média de caminhada)
            const estimatedDuration = totalDistance * 20 * 60 * 1000; // 20 min/km em milissegundos
            console.log(`⏱️ Duração estimada: ${estimatedDuration} ms`);
            
            // Mostrar modal de confirmação
            console.log('🔄 Chamando modal de confirmação...');
            showRouteConfirmationModal(totalDistance, estimatedDuration);
        }

        // Mostrar modal de confirmação para salvar rota
        function showRouteConfirmationModal(distance, duration) {
            console.log('🔄 Iniciando criação do modal de confirmação...');
            console.log('📊 Parâmetros recebidos:', { distance, duration });
            
            const distanceFormatted = Math.round(distance * 100) / 100;
            const durationFormatted = Math.round(duration / 1000 / 60);
            
            console.log('📏 Distância formatada:', distanceFormatted, 'km');
            console.log('⏱️ Duração formatada:', durationFormatted, 'min');
            
            // Criar modal de confirmação
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'route-confirmation-modal';
            confirmationModal.innerHTML = `
                <div class="confirmation-content">
                    <div class="confirmation-header">
                        <h3>💾 Confirmar Salvamento da Rota</h3>
                        <button class="close-btn" onclick="closeConfirmationModal()">&times;</button>
                    </div>
                    
                    <div class="confirmation-body">
                        <div class="route-summary">
                            <h4>📊 Resumo da Rota</h4>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">📸 Fotos:</span>
                                    <span class="summary-value">${appState.gpxPhotos.length}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">📍 Pontos:</span>
                                    <span class="summary-value">${appState.gpxData.totalPoints}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">📏 Distância:</span>
                                    <span class="summary-value">${distanceFormatted} km</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">⏱️ Tempo estimado:</span>
                                    <span class="summary-value">${durationFormatted} min</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="confirmation-message">
                            <p><strong>Esta rota será salva no histórico de rotas gravadas junto com suas outras rotas.</strong></p>
                            <p>Você poderá visualizá-la, editá-la ou excluí-la posteriormente no painel de rotas gravadas.</p>
                        </div>
                        
                        <div class="name-input-section">
                            <label for="routeNameInput">Nome da Rota:</label>
                            <input type="text" id="routeNameInput" 
                                   placeholder="Digite um nome para esta rota" 
                                   value="Rota de Fotos - ${new Date().toLocaleDateString('pt-BR')}"
                                   maxlength="50">
                            <small>Máximo 50 caracteres</small>
                        </div>
                    </div>
                    
                    <div class="confirmation-actions">
                        <button class="btn-secondary" onclick="closeConfirmationModal()">
                            ❌ Cancelar
                        </button>
                        <button class="btn-success" onclick="confirmSaveRoute()">
                            💾 Salvar Rota
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar estilos
            confirmationModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            document.body.appendChild(confirmationModal);
            
            // Focar no campo de nome
            setTimeout(() => {
                const nameInput = document.getElementById('routeNameInput');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.select();
                }
            }, 100);
            
            // Adicionar navegação por teclado
            document.addEventListener('keydown', handleConfirmationKeyboard);
            
            console.log('✅ Modal de confirmação criado e adicionado ao DOM');
            console.log('🔍 Modal encontrado:', document.querySelector('.route-confirmation-modal'));
        }

        // Fechar modal de confirmação
        function closeConfirmationModal() {
            const modal = document.querySelector('.route-confirmation-modal');
            if (modal) {
                modal.remove();
            }
            // Remover listener de teclado
            document.removeEventListener('keydown', handleConfirmationKeyboard);
        }

        // Navegação por teclado para o modal de confirmação
        function handleConfirmationKeyboard(event) {
            switch (event.key) {
                case 'Enter':
                    event.preventDefault();
                    confirmSaveRoute();
                    break;
                case 'Escape':
                    event.preventDefault();
                    closeConfirmationModal();
                    break;
            }
        }

        // Confirmar e salvar a rota
        async function confirmSaveRoute() {
            const routeName = document.getElementById('routeNameInput').value.trim();
            
            if (!routeName) {
                alert('Por favor, digite um nome para a rota.');
                return;
            }
            
            if (routeName.length > 50) {
                alert('O nome da rota deve ter no máximo 50 caracteres.');
                return;
            }
            
            try {
                console.log('💾 Iniciando salvamento da rota com imagens...');
                
                // Calcular distância total da rota
                let totalDistance = 0;
                for (let i = 1; i < appState.gpxData.waypoints.length; i++) {
                    const prev = appState.gpxData.waypoints[i - 1];
                    const curr = appState.gpxData.waypoints[i];
                    totalDistance += getDistanceFromLatLonInKm(prev.lat, prev.lon, curr.lat, curr.lon);
                }
                
                // Calcular duração estimada
                const estimatedDuration = totalDistance * 20 * 60 * 1000;
                
                // Processar e comprimir imagens
                console.log('🖼️ Processando imagens para salvar...');
                const processedPhotos = await processPhotosForStorage(appState.gpxPhotos);
                
                // Criar dados da rota
                const routeData = {
                    id: Date.now(),
                    name: routeName,
                    duration: estimatedDuration,
                    distance: totalDistance,
                    coordinates: appState.gpxData.waypoints.map(wp => ({
                        lat: wp.lat,
                        lng: wp.lon,
                        timestamp: wp.timestamp || new Date(),
                        name: wp.name,
                        description: wp.description
                    })),
                    timestamp: new Date(),
                    source: 'photos',
                    photoCount: appState.gpxPhotos.length,
                    waypointCount: appState.gpxData.totalPoints,
                    photos: processedPhotos // Imagens processadas
                };
                
                console.log('📊 Dados da rota criados:', routeData);
                console.log('🖼️ Imagens processadas:', processedPhotos.length);
                
                // Verificar tamanho dos dados antes de salvar
                const dataSize = JSON.stringify(routeData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (dataSize > maxSize) {
                    console.warn('⚠️ Dados muito grandes, salvando sem imagens...');
                    delete routeData.photos;
                    routeData.photoCount = appState.gpxPhotos.length;
                    routeData.photoWarning = 'Imagens não salvas devido ao tamanho';
                }
                
                // Salvar no localStorage junto com as outras rotas gravadas
                const savedRoutes = JSON.parse(localStorage.getItem('recordedRoutes') || '[]');
                savedRoutes.push(routeData);
                localStorage.setItem('recordedRoutes', JSON.stringify(savedRoutes));
                
                console.log('✅ Rota salva com sucesso no localStorage');
                
                // Fechar modal de confirmação
                closeConfirmationModal();
                
                // Mostrar mensagem de sucesso
                showPhotoRouteSavedNotification(routeData);
                
                // Fechar modal GPX
                closeGPXModal();
                
                // Atualizar interface se o painel de rotas estiver aberto
                if (appState.currentPanel === 'routes') {
                    // Recarregar painel de rotas se estiver aberto
                    console.log('🔄 Painel de rotas será atualizado na próxima abertura');
                }
                
            } catch (error) {
                console.error('❌ Erro ao salvar rota:', error);
                alert('Erro ao salvar a rota. Tente novamente.');
            }
        }

        // Mostrar notificação de rota salva
        function showPhotoRouteSavedNotification(routeData) {
            const distance = Math.round(routeData.distance * 100) / 100;
            const duration = Math.round(routeData.duration / 1000 / 60);
            
            // Verificar se as imagens foram salvas
            let imageInfo = '';
            if (routeData.photos && routeData.photos.length > 0) {
                const totalSize = routeData.photos.reduce((sum, photo) => sum + (photo.size || 0), 0);
                const avgSize = Math.round(totalSize / routeData.photos.length / 1024);
                imageInfo = `
                    <p><strong>🖼️ Imagens salvas:</strong> ${routeData.photos.length} (${Math.round(totalSize / 1024)}KB total)</p>
                    <p><strong>📏 Tamanho médio:</strong> ${avgSize}KB por imagem</p>
                `;
            } else if (routeData.photoWarning) {
                imageInfo = `
                    <p style="color: #ff6b6b;"><strong>⚠️ ${routeData.photoWarning}</strong></p>
                `;
            }
            
            const notification = document.createElement('div');
            notification.className = 'route-saved-notification';
            notification.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3>✅ Rota Salva com Sucesso!</h3>
                    <p><strong>Nome:</strong> ${routeData.name}</p>
                    <p><strong>Distância:</strong> ${distance} km</p>
                    <p><strong>Tempo estimado:</strong> ${duration} min</p>
                    <p><strong>Fotos:</strong> ${routeData.photoCount}</p>
                    <p><strong>Pontos:</strong> ${routeData.waypointCount}</p>
                    ${imageInfo}
                    <p style="margin-top: 15px; font-size: 12px; color: #666;">
                        A rota foi salva no histórico de rotas gravadas!
                    </p>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                border: 3px solid #28a745;
            `;
            
            document.body.appendChild(notification);
            
            // Remover após 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Função de teste para debug
        function testGPXFunctionality() {
            console.log('🧪 Testando funcionalidades GPX...');
            console.log('📊 Estado atual:', appState);
            console.log('🗺️ Mapa disponível:', !!appState.map);
            console.log('📸 Fotos GPX:', appState.gpxPhotos);
            console.log('🗺️ Dados GPX:', appState.gpxData);
            
            // Testar se EXIF.js está funcionando
            if (typeof EXIF !== 'undefined') {
                console.log('✅ EXIF.js está disponível');
                console.log('🔍 Versão EXIF:', EXIF.version);
            } else {
                console.error('❌ EXIF.js não está disponível');
            }
            
            // Testar se o modal está funcionando
            const modal = document.getElementById('gpxModal');
            if (modal) {
                console.log('✅ Modal GPX encontrado');
                console.log('👁️ Modal visível:', modal.classList.contains('show'));
            } else {
                console.error('❌ Modal GPX não encontrado');
            }
        }

        // Função de teste para o modal de confirmação
        function testConfirmationModal() {
            console.log('🧪 Testando modal de confirmação...');
            
            // Simular dados de teste
            const testDistance = 2.5; // 2.5 km
            const testDuration = 50 * 60 * 1000; // 50 minutos em ms
            
            console.log('📊 Dados de teste:', { testDistance, testDuration });
            
            // Chamar o modal de confirmação
            showRouteConfirmationModal(testDistance, testDuration);
        }

        // Visualizar fotos de uma rota
        function viewRoutePhotos(routeId) {
            const savedRoutes = JSON.parse(localStorage.getItem('recordedRoutes') || '[]');
            const route = savedRoutes.find(r => r.id === routeId);
            
            if (!route || !route.photos) {
                alert('Nenhuma foto encontrada para esta rota.');
                return;
            }
            
            console.log('🖼️ Visualizando fotos da rota:', route.name);
            
            // Criar modal para exibir as fotos
            const photoModal = document.createElement('div');
            photoModal.className = 'photo-viewer-modal';
            photoModal.innerHTML = `
                <div class="photo-viewer-content">
                    <div class="photo-viewer-header">
                        <h3>🖼️ Fotos da Rota: ${route.name}</h3>
                        <button class="close-btn" onclick="closePhotoViewer()">&times;</button>
                    </div>
                    <div class="photo-viewer-body">
                        <div class="photo-grid">
                            ${route.photos.map((photo, index) => `
                                <div class="photo-item">
                                    <img src="${photo.data}" alt="${photo.name}" onclick="openPhotoFullscreen('${photo.data}', '${photo.name}')">
                                    <div class="photo-info">
                                        <div class="photo-name">${photo.name}</div>
                                        <div class="photo-details">
                                            ${photo.width}x${photo.height} • ${Math.round(photo.size / 1024)}KB
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar estilos
            photoModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            document.body.appendChild(photoModal);
        }

        // Fechar visualizador de fotos
        function closePhotoViewer() {
            const modal = document.querySelector('.photo-viewer-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Abrir foto em tela cheia
        function openPhotoFullscreen(photoData, photoName) {
            const fullscreenModal = document.createElement('div');
            fullscreenModal.className = 'fullscreen-photo-modal';
            fullscreenModal.innerHTML = `
                <div class="fullscreen-photo-content">
                    <button class="close-btn" onclick="closeFullscreenPhoto()">&times;</button>
                    <img src="${photoData}" alt="${photoName}">
                    <div class="photo-caption">${photoName}</div>
                </div>
            `;
            
            fullscreenModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
                animation: fadeIn 0.3s ease-out;
            `;
            
            document.body.appendChild(fullscreenModal);
        }

        // Fechar foto em tela cheia
        function closeFullscreenPhoto() {
            const modal = document.querySelector('.fullscreen-photo-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Processar fotos para armazenamento no localStorage
        async function processPhotosForStorage(photos) {
            console.log('🖼️ Iniciando processamento de fotos para armazenamento...');
            
            if (!photos || photos.length === 0) {
                console.log('❌ Nenhuma foto para processar');
                return [];
            }
            
            const processedPhotos = [];
            
            for (let i = 0; i < photos.length; i++) {
                const photo = photos[i];
                console.log(`🔄 Processando foto ${i + 1}/${photos.length}: ${photo.name}`);
                
                try {
                    // Comprimir e redimensionar a foto
                    const processedPhoto = await compressAndResizePhoto(photo);
                    processedPhotos.push(processedPhoto);
                    console.log(`✅ Foto ${i + 1} processada com sucesso`);
                } catch (error) {
                    console.error(`❌ Erro ao processar foto ${i + 1}:`, error);
                    // Adicionar foto sem processamento como fallback
                    processedPhotos.push({
                        name: photo.name,
                        size: photo.size,
                        type: photo.type,
                        error: 'Erro no processamento'
                    });
                }
            }
            
            console.log(`✅ Processamento concluído: ${processedPhotos.length} fotos`);
            return processedPhotos;
        }

        // Comprimir e redimensionar uma foto
        function compressAndResizePhoto(photo) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    try {
                        // Calcular novas dimensões (máximo 800x600)
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        // Configurar canvas
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Desenhar imagem redimensionada
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Converter para base64 com compressão
                        const quality = 0.7; // 70% de qualidade
                        const dataURL = canvas.toDataURL('image/jpeg', quality);
                        
                        // Criar objeto da foto processada
                        const processedPhoto = {
                            name: photo.name,
                            type: 'image/jpeg',
                            size: Math.round(dataURL.length * 0.75), // Aproximação do tamanho
                            width: width,
                            height: height,
                            data: dataURL,
                            timestamp: new Date().toISOString(),
                            originalSize: photo.size
                        };
                        
                        console.log(`📊 Foto processada: ${photo.name} -> ${width}x${height}, ${Math.round(processedPhoto.size / 1024)}KB`);
                        resolve(processedPhoto);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Erro ao carregar imagem'));
                };
                
                // Carregar imagem do arquivo
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(photo);
            });
        }

        function startRecording() {
            if (!appState.currentLocation) {
                alert('Localização não disponível. Por favor, permita o acesso à sua localização.');
                return;
            }

            recordingState.isRecording = true;
            recordingState.isPaused = false;
            recordingState.startTime = new Date();
            recordingState.coordinates = [appState.currentLocation];

            // Iniciar monitoramento de localização
            if (navigator.geolocation) {
                recordingState.watchId = navigator.geolocation.watchPosition(
                    updateRecordingPosition,
                    console.error,
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }

            // Atualizar interface
            document.getElementById('recBtn').classList.add('recording');
            document.getElementById('recordingControls').classList.remove('hidden');
            
            // Mostrar notificação
            showRecordingNotification('🎥 Gravação iniciada!');
        }

        function pauseRecording() {
            if (!recordingState.isRecording) return;

            if (recordingState.isPaused) {
                // Retomar gravação
                recordingState.isPaused = false;
                recordingState.totalPausedTime += new Date() - recordingState.pauseTime;
                document.querySelector('.pause-btn i').className = 'fas fa-pause';
                showRecordingNotification('▶️ Gravação retomada!');
            } else {
                // Pausar gravação
                recordingState.isPaused = true;
                recordingState.pauseTime = new Date();
                document.querySelector('.pause-btn i').className = 'fas fa-play';
                showRecordingNotification('⏸️ Gravação pausada!');
            }
        }

        function stopRecording() {
            if (!recordingState.isRecording) return;

            // Parar monitoramento
            if (recordingState.watchId) {
                navigator.geolocation.clearWatch(recordingState.watchId);
                recordingState.watchId = null;
            }

            // Calcular duração total
            const totalDuration = new Date() - recordingState.startTime - recordingState.totalPausedTime;
            const activeDuration = totalDuration - recordingState.totalPausedTime;

            // Salvar rota gravada
            saveRecordedRoute(activeDuration, recordingState.coordinates);

            // Resetar estado
            recordingState = {
                isRecording: false,
                isPaused: false,
                startTime: null,
                pauseTime: null,
                totalPausedTime: 0,
                coordinates: [],
                watchId: null
            };

            // Atualizar interface
            document.getElementById('recBtn').classList.remove('recording');
            document.getElementById('recordingControls').classList.add('hidden');
            document.querySelector('.pause-btn i').className = 'fas fa-pause';

            showRecordingNotification('⏹️ Gravação finalizada!');
        }

        function updateRecordingPosition(position) {
            if (!recordingState.isRecording || recordingState.isPaused) return;

            const newCoord = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                timestamp: new Date()
            };

            recordingState.coordinates.push(newCoord);

            // Desenhar rota no mapa
            drawRecordingRoute();
        }

        function drawRecordingRoute() {
            if (!appState.map || recordingState.coordinates.length < 2) return;

            // Remover rota anterior se existir
            if (appState.recordingRouteLayer) {
                appState.map.removeLayer(appState.recordingRouteLayer);
            }

            // Criar nova rota
            const routeCoords = recordingState.coordinates.map(coord => [coord.lat, coord.lng]);
            appState.recordingRouteLayer = L.polyline(routeCoords, {
                color: '#e74c3c',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 5'
            }).addTo(appState.map);
        }

        function saveRecordedRoute(duration, coordinates) {
            if (coordinates.length < 2) {
                alert('Rota muito curta para salvar.');
                return;
            }

            const routeName = `Rota Gravada - ${new Date().toLocaleString()}`;
            const routeData = {
                id: Date.now(),
                name: routeName,
                duration: duration,
                distance: calculateRouteDistance(coordinates),
                coordinates: coordinates,
                timestamp: new Date()
            };

            // Salvar no histórico
            const savedRoutes = JSON.parse(localStorage.getItem('recordedRoutes') || '[]');
            savedRoutes.push(routeData);
            localStorage.setItem('recordedRoutes', JSON.stringify(savedRoutes));

            // Mostrar resumo
            showRouteSummary(routeData);
        }

        function calculateRouteDistance(coordinates) {
            let totalDistance = 0;
            for (let i = 1; i < coordinates.length; i++) {
                const prev = coordinates[i - 1];
                const curr = coordinates[i];
                totalDistance += getDistanceFromLatLonInKm(prev.lat, prev.lng, curr.lat, curr.lng);
            }
            return totalDistance;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function showRouteSummary(routeData) {
            const duration = Math.round(routeData.duration / 1000 / 60); // em minutos
            const distance = Math.round(routeData.distance * 100) / 100; // em km
            
            alert(`🎯 Rota Gravada Salva!\n\n📏 Distância: ${distance} km\n⏱️ Duração: ${duration} min\n📍 Pontos: ${routeData.coordinates.length}\n\nRota salva no histórico!`);
        }

        function showRecordingNotification(message) {
            // Criar notificação temporária
            const notification = document.createElement('div');
            notification.className = 'recording-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            `;
            
            document.body.appendChild(notification);
            
            // Remover após 3 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Funções de interação (placeholder)
        function likeTrace(traceId) {
            const trace = appState.traces.find(t => t.id === traceId);
            if (trace) {
                trace.likes++;
                updateUserInterface();
            }
        }

        function commentTrace(traceId) {
            alert('Funcionalidade de comentários em desenvolvimento!');
        }

        function viewTraceDetails(traceId) {
            alert('Detalhes do rastro em desenvolvimento!');
        }

        function viewMission(missionId) {
            alert('Detalhes da missão em desenvolvimento!');
        }

        function editProfile() {
            alert('Edição de perfil em desenvolvimento!');
        }

        function requestOTP() {
            // Implemente a lógica para enviar um código de verificação para o telefone do usuário
            alert('Código de verificação enviado para o telefone!');
        }

        function recoverAccount() {
            // Implemente a lógica para recuperar a conta do usuário
            alert('Conta recuperada com sucesso!');
        }
    </script>
</body>
</html>
